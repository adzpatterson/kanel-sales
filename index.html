<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>Kanel Sales Hub</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<style>
@import url('https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&display=swap');
:root{--bg:#f0f2f5;--sf:#fff;--sf2:#f7f8fa;--bd:#e0e4ea;--ac:#1a56db;--acl:#e1effe;--gn:#059669;--gnl:#d1fae5;--gnbg:#ecfdf5;--rd:#dc2626;--rdl:#fee2e2;--rdbg:#fef2f2;--am:#d97706;--aml:#fef3c7;--ambg:#fffbeb;--tx:#111827;--txm:#6b7280;--txd:#9ca3af;--purple:#7c3aed;--purplel:#ede9fe;--teal:#0891b2;--teall:#cffafe}
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'DM Sans',sans-serif;background:var(--bg);color:var(--tx);font-size:14px;-webkit-font-smoothing:antialiased}

.setup{display:flex;flex-direction:column;align-items:center;justify-content:center;min-height:100vh;gap:16px;padding:32px;background:linear-gradient(135deg,#1a56db 0%,#7c3aed 100%)}
.setup h1{font-size:32px;font-weight:700;color:#fff}.setup p{color:rgba(255,255,255,.8);text-align:center;max-width:420px}
.setup code{background:rgba(255,255,255,.15);padding:4px 10px;border-radius:6px;font-size:13px;font-family:monospace;color:#fff}
.setup input{background:rgba(255,255,255,.95);border:none;border-radius:10px;padding:14px;font-family:monospace;font-size:14px;width:320px;text-align:center}
.setup-btn{padding:12px 36px;background:#fff;border:none;border-radius:10px;color:var(--ac);font-weight:700;cursor:pointer;font-size:15px;transition:transform .15s}
.setup-btn:hover{transform:scale(1.03)}.setup-err{color:#fca5a5;font-size:13px;display:none}

.shell{display:flex;min-height:100vh}
.side{width:230px;background:var(--sf);border-right:1px solid var(--bd);padding:16px 0;position:fixed;height:100vh;overflow-y:auto;z-index:10}
.side-hd{padding:0 18px 16px;border-bottom:1px solid var(--bd);margin-bottom:8px}
.side-hd h1{font-size:17px;font-weight:700;color:var(--ac);letter-spacing:-.3px}
.side-hd p{font-size:11px;color:var(--txm)}
.nav-item{padding:9px 18px;cursor:pointer;font-size:13px;color:var(--txm);display:flex;align-items:center;gap:8px;transition:all .15s;border-left:3px solid transparent}
.nav-item:hover{background:var(--sf2);color:var(--tx)}
.nav-item.active{background:var(--acl);color:var(--ac);font-weight:600;border-left-color:var(--ac)}
.nav-sep{font-size:10px;font-weight:700;color:var(--txd);padding:14px 18px 4px;text-transform:uppercase;letter-spacing:1.2px}
.main{margin-left:230px;padding:28px;flex:1;min-width:0;max-width:1400px}

.kg{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:14px;margin-bottom:22px}
.kpi{background:var(--sf);border:1px solid var(--bd);border-radius:12px;padding:18px 20px;transition:box-shadow .2s}
.kpi:hover{box-shadow:0 2px 8px rgba(0,0,0,.06)}
.kpi-l{font-size:11px;color:var(--txm);text-transform:uppercase;letter-spacing:.6px;font-weight:500}
.kpi-v{font-size:26px;font-weight:700;margin-top:6px;letter-spacing:-.5px}
.kpi-sub{font-size:12px;color:var(--txm);margin-top:2px}

.card{background:var(--sf);border:1px solid var(--bd);border-radius:12px;padding:20px;margin-bottom:18px;transition:box-shadow .2s}
.card:hover{box-shadow:0 2px 8px rgba(0,0,0,.04)}
.card-hd{display:flex;justify-content:space-between;align-items:center;margin-bottom:14px}
.card-t{font-size:16px;font-weight:600;letter-spacing:-.2px}
.card-sub{font-size:12px;color:var(--txm);margin-top:2px}
.cr{display:grid;grid-template-columns:1fr 1fr;gap:18px}
.cr3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:18px}

.dt{width:100%;border-collapse:collapse;font-size:13px}
.dt th{text-align:left;padding:10px 14px;background:var(--sf2);border-bottom:2px solid var(--bd);font-weight:600;font-size:11px;text-transform:uppercase;letter-spacing:.4px;white-space:nowrap;color:var(--txm)}
.dt td{padding:8px 14px;border-bottom:1px solid #f0f0f0}
.dt tbody tr:hover{background:#fafbfc}
.n{text-align:left;font-variant-numeric:tabular-nums}
.pos{color:var(--gn);font-weight:600}.neg{color:var(--rd);font-weight:600}
.xb{font-size:11px;padding:5px 12px;background:var(--sf2);border:1px solid var(--bd);border-radius:6px;cursor:pointer;font-weight:500;transition:all .15s}
.xb:hover{background:var(--acl);border-color:var(--ac);color:var(--ac)}
.badge{font-size:10px;padding:3px 8px;border-radius:4px;font-weight:600}
.badge-ecom{background:#dbeafe;color:#1d4ed8}.badge-corp{background:#fce7f3;color:#be185d}
.badge-grocery{background:#d1fae5;color:#065f46}.badge-pos{background:#e0e7ff;color:#4338ca}
.badge-who{background:#fef3c7;color:#92400e}.badge-dya{background:#ede9fe;color:#6d28d9}

.insight-box{border-radius:10px;padding:16px 20px;margin-bottom:14px;font-size:13px;line-height:1.6}
.insight-green{background:var(--gnbg);border-left:4px solid var(--gn);color:#065f46}
.insight-red{background:var(--rdbg);border-left:4px solid var(--rd);color:#991b1b}
.insight-amber{background:var(--ambg);border-left:4px solid var(--am);color:#92400e}
.insight-blue{background:#eff6ff;border-left:4px solid var(--ac);color:#1e40af}
.insight-purple{background:#faf5ff;border-left:4px solid var(--purple);color:#581c87}

.donut-wrap{display:flex;align-items:center;justify-content:center;gap:20px;padding:10px}
.donut-legend{font-size:12px;line-height:2}
.donut-legend span{display:inline-block;width:10px;height:10px;border-radius:50%;margin-right:6px;vertical-align:middle}

.q-box{background:linear-gradient(135deg,#eff6ff,#faf5ff);border:1px solid #c7d2fe;border-radius:10px;padding:18px 22px;margin-bottom:14px}
.q-box-title{font-size:13px;font-weight:700;color:var(--purple);margin-bottom:8px;text-transform:uppercase;letter-spacing:.5px}
.q-box ul{margin:0;padding-left:20px;font-size:13px;color:#374151;line-height:1.8}

.note{margin-top:16px;padding:16px;background:var(--sf2);font-size:12px;color:var(--txm);border-radius:8px}
.refresh-btn{display:flex;align-items:center;gap:6px;padding:7px 14px;background:var(--sf2);border:1px solid var(--bd);border-radius:8px;cursor:pointer;font-size:12px;color:var(--txm);font-weight:500;transition:all .15s}
.refresh-btn:hover{border-color:var(--ac);color:var(--ac);background:var(--acl)}
.spin{animation:spin .8s linear infinite}@keyframes spin{to{transform:rotate(360deg)}}
.hidden{display:none!important}
.page-title{font-size:24px;font-weight:700;letter-spacing:-.5px}
.page-sub{font-size:12px;color:var(--txm);margin-top:2px}
@media(max-width:768px){.side{display:none}.main{margin-left:0}.cr{grid-template-columns:1fr}.cr3{grid-template-columns:1fr}.kg{grid-template-columns:repeat(2,1fr)}}
</style>
</head><body>
<div id="setupScreen" class="setup">
<h1>Kanel Sales Hub</h1>
<p>Make sure the sales proxy is running:</p>
<code>node sales-proxy.js</code>
<p style="font-size:12px;margin-top:8px">The proxy connects to Fishbowl from your machine and serves data to this dashboard.</p>
<label style="font-size:12px;color:rgba(255,255,255,.7);text-transform:uppercase;letter-spacing:1px;margin-top:16px">Proxy URL</label>
<input type="text" id="setupUrl" value="http://localhost:3848">
<button class="setup-btn" onclick="saveConfig()">Connect</button>
<div id="setupError" class="setup-err"></div>
</div>

<div id="app" class="hidden">
<div class="shell">
<div class="side">
<div class="side-hd" style="display:flex;align-items:center;gap:10px">
<img src="data:image/jpeg;base64,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" style="width:32px;height:32px;border-radius:50%" alt="Kanel">
<div><h1>Sales Hub</h1><p id="lastUpdated">Not connected</p></div>
</div>
<div style="padding:8px 18px 8px">
<button class="refresh-btn" id="refreshBtn" onclick="refreshData()" style="width:100%;justify-content:center">
<svg id="refreshIcon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" style="width:14px;height:14px"><path d="M1 4v6h6"/><path d="M23 20v-6h-6"/><path d="M20.49 9A9 9 0 0 0 5.64 5.64L1 10m22 4l-4.64 4.36A9 9 0 0 1 3.51 15"/></svg>
Refresh Data</button>
<button class="refresh-btn" id="exportBtn" onclick="exportOffline()" style="width:100%;justify-content:center;margin-top:6px;background:var(--sf2);color:var(--tx);border:1px solid var(--bd)">
<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" style="width:14px;height:14px"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
Export Offline</button>
</div>
<div class="nav-sep">Command Center</div>
<div class="nav-item active" data-page="exec">Executive Summary</div>
<div class="nav-item" data-page="dash">KPI Dashboard</div>
<div class="nav-item" data-page="pulse">Weekly Pulse</div>
<div class="nav-sep">Revenue Intelligence</div>
<div class="nav-item" data-page="comp">Comp % Analysis</div>
<div class="nav-item" data-page="chan">Channel Deep Dive</div>
<div class="nav-item" data-page="cat">Category Mix</div>
<div class="nav-item" data-page="sku">SKU Performance</div>
<div class="nav-item" data-page="yoy">YoY Trends</div>
<div class="nav-sep">Profitability</div>
<div class="nav-item" data-page="margin">Margin Analysis</div>
<div class="nav-item" data-page="who">Wholesale Accounts</div>
<div class="nav-sep">Coming Soon</div>
<div class="nav-item" data-page="roadmap" style="opacity:0.6">Roadmap</div>

</div>
<div class="main" id="M"><div class="card" style="text-align:center;padding:40px;color:var(--txm)">Loading data from Fishbowl...</div></div>
</div>
</div>

<script>

const ASSETS={logo:"data:image/png;base64,/9j/4AAQSkZJRgABAQAAAQABAAD/4gHYSUNDX1BST0ZJTEUAAQEAAAHIAAAAAAQwAABtbnRyUkdCIFhZWiAH4AABAAEAAAAAAABhY3NwAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAQAA9tYAAQAAAADTLQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAlkZXNjAAAA8AAAACRyWFlaAAABFAAAABRnWFlaAAABKAAAABRiWFlaAAABPAAAABR3dHB0AAABUAAAABRyVFJDAAABZAAAAChnVFJDAAABZAAAAChiVFJDAAABZAAAAChjcHJ0AAABjAAAADxtbHVjAAAAAAAAAAEAAAAMZW5VUwAAAAgAAAAcAHMAUgBHAEJYWVogAAAAAAAAb6IAADj1AAADkFhZWiAAAAAAAABimQAAt4UAABjaWFlaIAAAAAAAACSgAAAPhAAAts9YWVogAAAAAAAA9tYAAQAAAADTLXBhcmEAAAAAAAQAAAACZmYAAPKnAAANWQAAE9AAAApbAAAAAAAAAABtbHVjAAAAAAAAAAEAAAAMZW5VUwAAACAAAAAcAEcAbwBvAGcAbABlACAASQBuAGMALgAgADIAMAAxADb/2wBDAAUDBAQEAwUEBAQFBQUGBwwIBwcHBw8LCwkMEQ8SEhEPERETFhwXExQaFRERGCEYGh0dHx8fExciJCIeJBweHx7/2wBDAQUFBQcGBw4ICA4eFBEUHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh7/wAARCADwAnADASIAAhEBAxEB/8QAGwABAAMBAQEBAAAAAAAAAAAAAAQFBgMBAgj/xAA7EAACAgECAgUKBAcBAQADAAAAAQIDBAURIXEGEjFBURMVMjM1U2FygZEUIjSxQlJUYpKhwSNDJNHh/8QAFgEBAQEAAAAAAAAAAAAAAAAAAAEC/8QAGBEBAQEBAQAAAAAAAAAAAAAAAAERMSH/2gAMAwEAAhEDEQA/APxkAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAADvVh5NkVKFM3F9j2O9elZcv4FHmBBBaQ0W9+lOC5HeGiR/juf0QXFIDQPSMWEJN9aTS8Sglwk18QmPAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAEmGDlzSaons+/Y7w0jLl2qMebArwW0NEt/jsiuR3holS9K6T5ILiiBdahpuPj4c7IpuS22e5ShAAAAAAAAAAAWGNquRRXCtRjKMVsky00/U6smXk5LqT8H2MzZ7CThJSi9mnugutkDhgXrIxYW97Wz5ncNPm31UuTMfL0nzNhb6qXJmPl6T5hmvAAEAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAD1PZ7ngAs6dZvhspQjJLgW2BnVZcX1fyzXbFmWOuLdKjIhbHtTCytcDyuSnCM0901uehpD1r2fZ9DMGn1r2fZ9DMBmgACAAAAAAAAAAA0PR6W+F1fCTLIqujkt8eyPhItQ3Hzb6qXJmPl6T5mwt9VLkzHy9J8wzXgACAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAADVaW99Ppf9pJImj+z6uRLDcQ9a9n2fQzBp9a9n2fQzAZoAAgAAAAAAAAAALzo16q3mi3Kjo16q3mi3DcfNvqpcmY+XpPmbC31UuTMfL0nzDNeAAIAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAANRo/s+rkSyJo/s+rkSw3EPWvZ9n0MwafWvZ9n0MwGaAAIAAAAAAAAAAC86Neqt5otyo6Neqt5otw3Hzb6qXJmPl6T5mwt9VLkzHy9J8wzXgACAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAADUaP7Pq5EsiaP7Pq5EsNxD1r2fZ9DMGn1r2fZ9DMBmgACAAAAAAAAAAAvOjXqreaLcqOjXqreaLcNx82+qlyZj5ek+ZsLfVS5Mx8vSfMM14StOoovlNX3eSSXD4kUBF3XpGLYt4ZMpctj78x0++n9kUcLJwkpQk014M0mj5UsnG3n6cXs34hZiP5jp99P7IeY6ffT+yLUqtS1WNe9WPtKffLuQXx8y0bHit5ZEkvjscLcDBhCTWY3JLguBXW3W2ycrLJSfM5hAABAA9jFykopbt9gBJt7JNsnY2lZVvGUfJr+4t9MwK8atSklKxri/AmhqRU1aJUtnZbJvwR2np+n0Q61qSXi2TrrI1VSsm9lFbmWzcqzKuc5t7dy8AXInzt0iMtlQ5fFHSmvScjhH8kn2JspAE1eW6JW1vVbJPwfYQcnS8qlbqPXXjEkaNqEozWPc94vhFvuL0LkrGtNPZppnhqszCoyYbSilLuku0zmbjWYtzrn9H4hLHAABAkY2HkZEetXW3HxI5Ix83Joj1a7Go+AEqGjZUlu3CPNneGiP+O7bkj6wdY601DIilvwUkXC4rdBqSKuGi469KycjrPS8RVS2r3l1eD3J4C4xsl1ZOL7nsewjKclGMW2+5EynCsy8y1Q/LBTe8vqTrbsTTI+Tpip3bcX/+wziLjaRfYlK1quPx7SZXpmFV6y3rc2VeRn5N7fWsaXguwjOUn2t/cHjSx0/T36NcX9T6lpuE+2lfczMZzi94yknzJ+Hqt9LStflIfHtQNiwu0bHn6EpQ5Fbl6XkULrJeUj4ruNBj3V31Kyt7xZ0C4xgNBq2mxui7aIqNi7Uv4igaabT7UGbHgAAAAAAdcaizIsVdcd3+wHIm4um5N+z6nUj4yLfA02nHSlNKdni+47ahl14lPWfGT9GIXEBaTjUx6+Re9u/wOc7NIr4Kp2fFFbk5FuRY52zb+HcjkDVxVZo83s6ep8xJel4V8OtVJpPscXuZ4kYeXbi2KVcuHfHuYNTMnRroJypkprw7ytshOuTjOLi13M1eHk15VKsg+a8GeZmJTlVuNkVv3S70FxkwSc/DsxLOrPjF9kvEjBkAAAAAajR/Z9XIlkTR/Z9XIlhuIetez7PoZg0+tez7PoZgM0AAQAAAAAAAAAAF50a9VbzRblR0a9VbzRbhuPm31UuTMfL0nzNhb6qXJmPl6T5hmvAAEDR6DS6sPryWzm9/oVWk4TyrutJbVx7X4/Am6xnqEfw2O9n2Sa7vgFj41jUutvj0S/L2Sku8pwAgAAAAAHbCko5dUpPZKSOIA2a4pMFHgav5OtV5EXLbgpIlXaxjRjvBSm/ANa+OkV/VpjRF8ZPdr4FCdcu+eTc7bHxf+jkGaAAD1PZ7mrwLfLYddj7XHiZM0XR+TlhbP+GWwWLEg61QrsOUtvzQ4pk4+Mhb0WL+1/sGmPAAYAAANJoV7tw1GT4w4fQzZcdGpfntj8EwsXYADSFqV8MLEfk0oyk+CXi+8zUpOUnKT3b4tlj0htc8xV90F+5WhmgACAAAs9AyXXk+Rk/yT/c0BkcWXVya5eEkzXJ7pPxDUDO69jqnK8pFflsW/JmiKrpIl+Grl39fb/QKoQAGQAAdcWieRdGqtcX3+Bp8HFrxaVCC4/xPxOGj4ix8dSkv/SfF/AnBqR82TjXXKcnskt2ZXOyJZORKyXZ3LwRc9Ib3XjRqi+M3x5GfCWgACAAAnaLkOjLjFv8AJPgzSmNT2afga3Es8rjV2fzRDUeZuPDJodc1yfgzK31yptlXNfmi9mbApOkdCU4XpelwYKpwAGQAAajR/Z9XIlkTR/Z9XIlhuIetez7PoZg0+tez7PoZgM0AAQAAAAAAAAAAF50a9VbzRblR0a9VbzRbhuPm31UuTMfL0nzNhb6qXJmPl6T5hmvCRgYs8q5QjwS9J+B84mPZk3Kutce9+BfW1SwdOksaG80uL7+YJEfUMqvBoWJi7dfbi13f/wBKRtttt7tiTcpOUm232tngQAAAAAAAAAAAAAAAAAAA0PR39HL5jPGn0eryWDDdbOXFhYmHzd6qfys+j5u9VP5WGmPl6TPD2XpM8DAAABb9GvX3fKv3KgtujS3yLX4RX7hYvQAGmW1WXXz7H8diKds79Xb8zOIYAAAAAHsHtNNeJsKuNUH/AGoxxsMf9PX8i/YLH2VfST9JX8//AAtCr6SfpK/n/wCBbxQAAMhM0ijy+bFP0Y/mZDL3o3XtVZa+97ILFsAA0o9eruuyo9SuUoxjtwRX/hMj3M/sXORq8Kb51Opvqvbfc5+e6/cv7hnxVfhMj3M/sPwmR7mf2LXz3X7l/cee6/cv7gyKr8Jke5n9h+EyPcz+xa+e6/cv7jz3X7l/cGRVfhMj3M/saHSFOODXGcXFx4bMh+e6/cv7jz3X7l/cLMW5C1yHW0+fimmRfPdfuX9zll6tC7HnWqmnJeILVQAAyAADUaP7Pq5EsiaP7Pq5EsNxD1r2fZ9DMGn1r2fZ9DMBmgACAAAAAAAAAAAvOjXqreaLcqOjXqreaLcNx82+qlyZk6qZ33+Trju2zW2JuEku1ora4U6Vju2zaVsgliVp+JDEpUUt5v0peJJOeNfXkVKyt7p/6OgVQ6zp/kpO+lfkfpJdxVGzklKLjJbp9qM5q+A8aflK03U/9BmxXgAIAAAAAAAAAAAD6hCU3tCLk/gSqdNy7f8A59Vf3cAIZ6k20kt2y5o0RcHdb9EdLLdP09NVxU7PDtC4jafpr4X5e0K1x2feW2Fk15MZupflhLqp+Jns3OuypfmfVh3RXYWnRr9Lb8//AALFqfN3qp/Kz6Pm71U/lYVj5ekzw9l6TPAwAAAW/Rr193yr9yoLfo16+75V+4WLwABpks1JZdqX8zOJ3zv1lvzM4BgAAAAADYY36ev5F+xjzYY36ev5F+wWPsq+kn6Sv5/+FoVfST9JX8//AALeKAABkNLoS206HxbZmjU6V+hr5BYlBgBpk8575lrf8xwJGox6uddHwkRwwAAAAAAAAAAAAAAAA1Gj+z6uRLImj+z6uRLDcQ9a9n2fQzBp9a9n2fQzAZoAAgAAAAAAAAAALzo16q3mi3Kjo16q3mi3DceSfVi34IymdkWZN8pzffwXgaq31UuTMfL0nzCVK03MniXbrjB+kjTVWQtrVkGnF9hjidpWdLFs6s+NUu1eASVpT5trhbW4TScX2o9hKM4qUXunxTPQ0y+pYc8S7xrl6LIhr8miGRS6rFun/ozGdjTxbnXNcP4X4oM2I4ACAAAAHTHpnfdGqC4yYHuNRbkWdSqLb7/gXWJo9UEpXyc5d67idhY1eLSoQXHvfizsGpHxVTVVHaFcYrkfOTkVY9fXtkkv3PrIthRTK2b2UUZbNyrMq5zm+HcvAFuJWfqlt+8K964f7ZXNtvdgBkL7o1+lt+f/AIUJfdGv0tvz/wDAsWp83eqn8rPo+bvVT+Vhpj5ekzw9l6TPAwAAAW/Rr193yr9yoLfo16+75V+4WLwABpk879Zb8zOB3zv1lvzM4BgAAAAADYY36ev5F+xjzYY36ev5F+wWPsq+kn6Sv5/+FoVfST9JX8//AALeKAABkNPo0utp9b5ozBoOjtnWxJV/yS/cLFmAA0zeu19TPlL+fiQC76SVbwruS7H1WUgZoAAgAAAAAAAAAAAAA1Gj+z6uRLImj+z6uRLDcQ9a9n2fQzBp9a9n2fQzAZoAAgAAAAAAAAAAL7o3HaiyXiy1Kzo6tsST8ZFmG4+bfVS5Mx8vSfM2Fvq5cmY+XpPmGa8AARZaPnvHl5K1t1t8PgaFNNJp7pmMLfRtQ6jWPfL8r9GT7vgFlXhwzsWvKpdc+3ufgzuA0yOTTZj2uuxbNf7ORqtQw68urZ8Jr0ZGZyKbKLXXYtmv9hmzHMABAuejdKbsva4r8qKY0PR79G/mCxZAANKXpHe94UJ/3Mpidrjb1Ce/ctiCGaAAIGh6Ow6uHJ/zS3M8avTa3Vg1Qa2e3ELEg+buFM3/AGs+j5u41TX9rDTHt7ts8PZcJNHgYAAALfo16+75V+5UFx0aX/pc/wC1BYuwAGmTzv1lvzM4HfPTWZan/MzgGAAAAAB6lu9jX0LaiteEV+xkYLecV4s19S2qgv7UFj6KvpJ+kr+f/haFX0jX/wCJD4T/AOBbxQAAMhYaFf5LMUJPaM1t9SvPYycZKUXs1xQGyBH07Jjk40Zr0lwkviSA245tKvxp1PvXAyk4uE3GS2aezRsSl17CfW/E1x4P00v3CWKYABkAAAAAD7pqsun1K4uUvBHwXOiU+Rx7MyfDg+ruBTyTjJxa2a7Tw+rZuyyU32ybZ8gAABqNH9n1ciWRdJW2nU/GO5KDcQ9a9n2fQzBqNXj1sCxfUy4ZoAAgAfVUJWWRhFbtvZAeRjKT2im38CVHTsyS3VEti+0/Cqxakkk5/wAUiUGsZC6m2p7WQlHmczYXVV3QcLIqSfiZrVMR4mR1VxhLjFhLEQHsU5PZJt/AsNN0226xTti4Vp9/awi20ap1YEE+1/m+5MEUkkktkuwBsfYZHKrdWTZW+1SNcV2rad+JflatlYlxXiEsZ0HS6i2mTjZCUdvgcwyAHqTb2S3AvtCzJXRdFj3lFbxfwLQpNAxbY3u+cXGKWy37y7DUCNqGHXl1bPhNejIkgKyORRZRa67ItNf7ORrcvFqya3CyPJ96KHM0vIobcF5SHiu0M2IBd9G7V1LKW+O+6XwKaUJRe0otc0dMO+WNkRtj3dq8UCNaDli315FSsre6favA6hpQdIanHKVu35ZL/ZVmr1DFjlY7rfCS4xfgzM5FFtE3C2DTDNjkASMTEvyZqNcHt3yfYEfWmY7yMuMdvyp7y5GpWyW3gVTtx9Ko8nDadz7SFhalZDNdl0m4z4SXgGp40Qa3TXieQlGcVKLTT7Gj0KyOXBwybIvukzkX+r6a8iXlqduv3rxKtadluXV8k9wziLFOT2im2+5Bpp7NbMvsLDr0+qWTkNOaX2KS6crr5T24ye+yCOZoOjtXVxpWNcZPhyKzC06/ImutFwh3tmkprjVVGuC2jFbILI+gAGma1ut158+HCSTRBNRqWFDLq27Jr0WZ/Jw8jHltZW9vFcUGbEcABAA+6qrLHtXCUuSA6YFbtzK4Jb/mTfI1i4LZFbo+nvG/9rdvKNbJeCLINQIWt1uzAm1/DxJoklKLi1umFYwFpqOlWVSdlC68O3bvRWSjKL2kmn4MMPAABL0zMliXp771y9JGmqshZBThJOL7GY4madn2YktvSrfbELK04klKLi1un2nHFyqcmClXNcu9HYNKHU9LlW3bjrrQ74+BVtNPZ8DZETL07GyH1nHqy8Y8AljLgtbtFui//KcZr48Dg9LzE9vJr7hnEEFhXpGXJrrKMVzJ+Lo1UH1rp9d+C4ILis03BsyrVwarXbIna3kQqpjh07LZfm27kSNQz6cSvyNCj19uCXYjPzlKc3OT3k3u2Dj5AAQPYpykku1s9hCc3tCLk/gi30jTZxsV962S4xiBbY1fkseFf8sdjoAG3PLh5TGshtu3F7GRaabTWzRsin1XS5TnK7HS48XEJYpAfdlc63tOEov4o+AyFhoMVLPTf8K3RXkvSblRmwlJ7RfBgagABsKzpFFPDjPbippblmVHSO+Pk4UJ7tvrP4BLxyq1TGrS6uJFNd5189w9y/uUYCavPPcPcv7jz3D3L+5RgGrzz3D3L+489w9y/uUYBq6nrFU1tPGUl8Sszba7r3OutVx27EcAECfg58ManqPGhN779Z9pAAFz58f9Ov8AIefH/Tr/ACKYBdXPnx/06/yHnx/06/yKYA1c+fH/AE6/yHnx/wBOv8imANW8tYhJ7yxIS5lTN9abaW2732PAEdsbJux59aqW3w7mW+NrNcklfBxfiiiAXWqjqGHJb+XgubPmzKwLFtZbTJfFoy4Bq9nfpVT3UIzfwW5FydWnKPUx4KqPwKwA17KTlJyk22+1s8ACJ2n6jbi/kf56/B9xcU6piWJb2KD7+twMyAutX+OxP6iv/JHG/VcStPqy67/tM0Aal6hnW5ctn+WC7Iok42pY9NUY/hYuSXaVYCLvz3D3L+5757h7l/cowF1eee4e5f3HnuHuX9yjANXnnuHuX9zyWtVyWzo3XxZSAGpeo5NWTKLrpVey47d5EACJGDdXRd17KlYtuxllDWKYehjKPIpQDV557h7l/cee4e5f3KMBdXnnuHuX9x57h7l/cowDV557h7l/c5Xapj2wkpYqba7SoANAAEAAB9VznXLrQk4vxTLHH1i+C2tirF9isAGiq1jGl6fWg+RIjqGHJevgubMqAutX+OxP6iv/ACR8y1DDj/8AeD5MywBrQ3axjxX/AJqU39iuy9VyL04x/wDOL7l2leAa9bbe7e7PAAgdMeca7oznHrxT4rxOYAuYavRD0MVR5H357h7l/cowF1eee4e5f3HnuHuX9yjANXnnuHuX9x57h7l/cowDVzZq9Fnp4qlzKixqVkpJbJvgj5AQAAFvpureTgqsjdpcFLvLOOfiNb+XgubRlQF1oczV6a4tU/8ApL/RQ3WTuslZY95PtPgBNAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAf/Z",circle:"data:image/jpeg;base64,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"};
let CFG=JSON.parse(localStorage.getItem('ksh-cfg')||'null'),D=null;
async function saveConfig(){const u=document.getElementById('setupUrl').value.replace(/\/$/,''),e=document.getElementById('setupError');e.style.display='none';try{const r=await fetch(`${u}/api/health`);if(!r.ok)throw new Error(`HTTP ${r.status}`);CFG={url:u};localStorage.setItem('ksh-cfg',JSON.stringify(CFG));document.getElementById('setupScreen').classList.add('hidden');document.getElementById('app').classList.remove('hidden');refreshData()}catch(x){e.style.display='block';e.textContent=`Failed: ${x.message}. Is proxy running?`}}
if(CFG){document.getElementById('setupScreen').classList.add('hidden');document.getElementById('app').classList.remove('hidden');fetch(`${CFG.url}/api/cached`).then(r=>r.ok?r.json():null).then(d=>{if(d&&!d.error){D=d;renderCurrent()}refreshData()}).catch(()=>refreshData())}
async function refreshData(){if(!CFG)return;const b=document.getElementById('refreshBtn'),i=document.getElementById('refreshIcon');b.disabled=true;i.classList.add('spin');try{const r=await fetch(`${CFG.url}/api/sales-data`);if(!r.ok)throw new Error(`HTTP ${r.status}`);D=await r.json();document.getElementById('lastUpdated').textContent='Updated '+new Date(D.updated).toLocaleString('en-CA',{month:'short',day:'numeric',hour:'2-digit',minute:'2-digit'});renderCurrent()}catch(e){if(!D)document.getElementById('M').innerHTML=`<div class="card" style="text-align:center;padding:40px;color:var(--rd)">Error: ${e.message}</div>`}b.disabled=false;i.classList.remove('spin')}

// Formatters
const F={
  $:v=>{if(v==null)return'-';const a=Math.abs(v);if(a>=1e6)return(v<0?'-':'')+'$'+(a/1e6).toFixed(3).replace(/\.?0+$/,'')+'M';if(a>=1e3)return(v<0?'-':'')+'$'+(a/1e3).toFixed(a>=1e5?0:1)+'K';return'$'+v.toLocaleString('en-US',{minimumFractionDigits:2,maximumFractionDigits:2})},
  $m:v=>{if(v==null)return'-';return(v<0?'-':'')+'$'+(Math.abs(v)/1e6).toFixed(3)+'M'},
  $f:v=>{if(v==null)return'-';return'$'+v.toLocaleString('en-US',{minimumFractionDigits:2,maximumFractionDigits:2})},
  n:v=>v==null?'-':v.toLocaleString('en-US',{maximumFractionDigits:0}),
  p:v=>v==null?'-':v.toFixed(1)+'%',
  mo:m=>['','Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'][m]||m,
  dow:d=>['Sun','Mon','Tue','Wed','Thu','Fri','Sat'][d]||d
};
function xT(id){const t=document.getElementById(id);if(!t)return;XLSX.writeFile(XLSX.utils.table_to_book(t),'kanel_export.xlsx')}
function classify(name){const n=(name||'').toLowerCase();if(n.includes('shopify pos'))return'POS';if(n.includes('shopify'))return'Ecommerce';if(n==='dya')return'Wholesale: DYA';const grocery=['loblaws','sobeys','metro','iga','maxi','provigo','avril','community natural','summerhill','purity life','rachelle','whole foods'];if(grocery.some(k=>n.includes(k)))return'Grocery';const corp=['corporate','peter and paul','biomed','corby','inspira','terra corporate','fairmont','hotel','remax','donovan','financiere','financiÃ¨re','tourisme','gilles lafleur','parisien','adams wealth','rbc','marketing kitchen','acart','addimpact','aevias'];if(corp.some(k=>n.includes(k)))return'Corporate';return'Wholesale: House Account'}
function categorize(pn,desc){pn=(pn||'').trim();desc=(desc||'').trim().toLowerCase();if(desc==='subtotal'||desc==='shipping'||desc==='tax')return'Subtotal';if(pn.startsWith('GIF-'))return'Gift';if(pn.startsWith('BLE-'))return'Spice Blend';if(pn.startsWith('SAL-'))return'Sea Salt';if(pn.startsWith('RIM-'))return'Cocktail Rimmer';if(pn.startsWith('REF-'))return'Refill';if(pn.startsWith('COL-'))return'Collection';if(pn.startsWith('STA-')||pn.startsWith('PRE-'))return'Starter/Prefill';if(pn.startsWith('MAR-')||pn.startsWith('POP-')||pn.startsWith('DEM-'))return'Marketing';const sK=['truffle salt','sea salt','garlic salt','peppercorn','fleur de sel','smoked salt','maple smoked','charred lemon','cold smoked','fiery sea','mineral','pure salt','summer sea salt','salt cellar'];if(sK.some(k=>desc.includes(k)))return'Sea Salt';const bK=['butcher','sunshine','stockholm','montreal bagel','sunday roast','korean heat','la vita','louisiana','taco night','green goddess','chipotle','bbq','smoky rub','chorizo','umami','curry','vadouvan','dukka','cinnamon','gingerbread','turmeric','tomato & fennel','pumpkin','jamaican jerk','aglio','bangkok','taqueria','chili crunch','coffee rub','bombshell','tonka sugar','cacao apple'];if(bK.some(k=>desc.includes(k)))return'Spice Blend';const rK=['caesar','margarita','berry breeze','cranberry spruce','sour cherry','rimmer','cocktail'];if(rK.some(k=>desc.includes(k)))return'Cocktail Rimmer';const gK=['collection','classic','voyager','traveler','traveller','top 5','best sellers','duo','trio','bundle','bright & fresh','smoke & fire','roasted & raw','24 karat','salt edit','gourmet','spice lovers','family faves','nirvana','piccolo','grande','medio','perfect 10','sparkle','advent','arrivals','harvest','holiday'];if(gK.some(k=>desc.includes(k)))return'Gift';if(desc.includes('refill'))return'Refill';if(['demo','signage','shelf talker','displayer','easel','pop'].some(k=>desc.includes(k)))return'Marketing';if(['vanilla','maple sugar','spoon','mill','cellar','dispenser','furoshiki','gift card','gift bag','personalized','custom'].some(k=>desc.includes(k)))return'Mixed';if(['discount','credit','escompte','rabais','retour','samples','listing fee','allowance','opening order'].some(k=>desc.includes(k)))return'Adjustments';if(desc.includes('shipping'))return'Shipping';return'Other'}
function comp(a,b){return b>0?((a/b-1)*100):null}
function compS(v){if(v==null)return'-';return'<span class="'+(v>=0?'pos':'neg')+'">'+(v>=0?'+':'')+F.p(v)+'</span>'}
function aggByChannel(rows){const ch={};(rows||[]).forEach(r=>{const c=classify(r.customer);if(!ch[c])ch[c]={revenue:0,orders:0};ch[c].revenue+=r.revenue;ch[c].orders+=r.orders});return ch}
function badgeCh(ch){const m={'Ecommerce':'ecom','Corporate':'corp','Grocery':'grocery','POS':'pos','Wholesale: House Account':'who','Wholesale: DYA':'dya'};return`<span class="badge badge-${m[ch]||'who'}">${ch}</span>`}

// SVG Donut chart
function donut(data,size=160){
  const total=data.reduce((s,d)=>s+d.value,0);if(!total)return'';
  const r=size/2,cx=r,cy=r,ri=r*0.6;
  let angle=0,paths='';
  data.forEach(d=>{
    const pct=d.value/total,a1=angle,a2=angle+pct*Math.PI*2;
    const x1=cx+r*Math.sin(a1),y1=cy-r*Math.cos(a1);
    const x2=cx+r*Math.sin(a2),y2=cy-r*Math.cos(a2);
    const ix1=cx+ri*Math.sin(a1),iy1=cy-ri*Math.cos(a1);
    const ix2=cx+ri*Math.sin(a2),iy2=cy-ri*Math.cos(a2);
    const large=pct>0.5?1:0;
    paths+=`<path d="M${x1},${y1} A${r},${r} 0 ${large},1 ${x2},${y2} L${ix2},${iy2} A${ri},${ri} 0 ${large},0 ${ix1},${iy1} Z" fill="${d.color}" opacity="0.85"/>`;
    angle=a2;
  });
  const centerText=F.$(total);
  return`<svg width="${size}" height="${size}" viewBox="0 0 ${size} ${size}">${paths}<text x="${cx}" y="${cy-4}" text-anchor="middle" font-size="11" fill="#6b7280" font-family="DM Sans">TOTAL</text><text x="${cx}" y="${cy+12}" text-anchor="middle" font-size="14" font-weight="700" fill="#111827" font-family="DM Sans">${centerText}</text></svg>`;
}
function donutLegend(data){
  const total=data.reduce((s,d)=>s+d.value,0);
  return data.map(d=>`<div><span style="background:${d.color}"></span>${d.label}: ${F.$(d.value)} (${total>0?F.p(d.value/total*100):'0%'})</div>`).join('');
}

// Get MTD data from daily query  
function getMTD(){
  const daily=D.daily||[];const now=new Date();const yr=now.getFullYear(),mo=now.getMonth()+1;
  let rev=0,ord=0;
  daily.forEach(r=>{
    const d=new Date(r.dt);
    if(d.getFullYear()===yr&&d.getMonth()+1===mo){rev+=r.revenue;ord+=r.orders}
  });
  return{revenue:rev,orders:ord};
}
function getWTD(){
  const tw=D.tw||[];
  return{revenue:tw.reduce((s,r)=>s+r.revenue,0),orders:tw.reduce((s,r)=>s+r.orders,0)};
}

// Weekly trailing from daily data
function getWeeklyTrailing(n){
  const daily=D.daily||[];const now=new Date();
  const day=now.getDay();const monOff=day===0?6:day-1;
  const weeks=[];
  for(let w=0;w<n;w++){
    const wMon=new Date(now);wMon.setDate(now.getDate()-monOff-7*w);wMon.setHours(0,0,0,0);
    const wSun=new Date(wMon);wSun.setDate(wMon.getDate()+6);wSun.setHours(23,59,59);
    let rev=0,ord=0;
    daily.forEach(r=>{const d=new Date(r.dt);if(d>=wMon&&d<=wSun){rev+=r.revenue;ord+=r.orders}});
    const fmt=d=>d.toLocaleDateString('en-CA',{month:'short',day:'numeric'});
    weeks.push({label:`${fmt(wMon)}-${fmt(wSun)}`,revenue:rev,orders:ord,from:wMon,to:wSun});
  }
  return weeks;
}

let currentPage='exec';
function renderCurrent(){
  if(PG[currentPage]){
    try{
      document.getElementById('M').innerHTML=PG[currentPage]();
    }catch(e){
      document.getElementById('M').innerHTML='<div class="card" style="padding:40px;color:var(--rd)"><div class="page-title">Error on '+currentPage+'</div><pre style="margin-top:12px;font-size:12px;white-space:pre-wrap">'+e.message+'\n\n'+e.stack+'</pre></div>';
      console.error('Page render error:',e);
    }
  }
}
const PG={};
const COLORS=['#1a56db','#059669','#d97706','#dc2626','#7c3aed','#0891b2','#be185d','#65a30d','#6366f1','#f97316'];

// ==================== EXECUTIVE SUMMARY ====================
PG.exec=function(){
  const c=D.ytd_cust||[],cp=D.ytd_prior||[];
  const totalRev=c.reduce((s,r)=>s+r.revenue,0),totalOrd=c.reduce((s,r)=>s+r.orders,0);
  const priorRev=cp.reduce((s,r)=>s+r.revenue,0);
  const ytdComp=comp(totalRev,priorRev);
  const mtd=getMTD(),wtd=getWTD();
  const chData=aggByChannel(c),chPrior=aggByChannel(cp);

  // Category data
  const prods=(D.ytd_products||[]).filter(p=>!['Subtotal','Shipping','Adjustments'].includes(categorize(p.productNum,p.description)));
  const cats={};prods.forEach(p=>{const cat=categorize(p.productNum,p.description);if(!cats[cat])cats[cat]={revenue:0,count:0};cats[cat].revenue+=p.revenue;cats[cat].count++});
  const catList=Object.entries(cats).filter(([k,v])=>v.revenue>0).sort((a,b)=>b[1].revenue-a[1].revenue);

  // Monthly trend
  const byMo={};(D.monthly||[]).forEach(r=>{byMo[r.yr+'-'+String(r.mo).padStart(2,'0')]=r.revenue});

  let h='<div style="margin-bottom:24px"><div class="page-title">Executive Summary</div><div class="page-sub">Fiscal YTD: Jul 27, 2025  -  Present</div></div>';

  // KPI row
  h+='<div class="kg" style="grid-template-columns:repeat(6,1fr)">';
  h+=`<div class="kpi"><div class="kpi-l">YTD Revenue</div><div class="kpi-v">${F.$m(totalRev)}</div></div>`;
  h+=`<div class="kpi"><div class="kpi-l">Prior YTD</div><div class="kpi-v">${F.$m(priorRev)}</div></div>`;
  h+=`<div class="kpi"><div class="kpi-l">YTD Comp</div><div class="kpi-v" style="color:${ytdComp>=0?'var(--gn)':'var(--rd)'}">${compS(ytdComp)}</div></div>`;
  h+=`<div class="kpi"><div class="kpi-l">MTD Revenue</div><div class="kpi-v">${F.$(mtd.revenue)}</div></div>`;
  h+=`<div class="kpi"><div class="kpi-l">WTD Revenue</div><div class="kpi-v">${F.$(wtd.revenue)}</div></div>`;
  h+=`<div class="kpi"><div class="kpi-l">YTD Orders</div><div class="kpi-v">${F.n(totalOrd)}</div></div>`;
  h+='</div>';

  // Insights section
  const topCh=Object.entries(chData).sort((a,b)=>b[1].revenue-a[1].revenue);
  const whRev=(chData['Wholesale: House Account']||{revenue:0}).revenue;
  const whPrior=(chPrior['Wholesale: House Account']||{revenue:0}).revenue;
  const whComp=comp(whRev,whPrior);
  const ecomRev=(chData['Ecommerce']||{revenue:0}).revenue;
  const ecomPrior=(chPrior['Ecommerce']||{revenue:0}).revenue;
  const ecomComp=comp(ecomRev,ecomPrior);
  const grcRev=(chData['Grocery']||{revenue:0}).revenue;
  const grcPrior=(chPrior['Grocery']||{revenue:0}).revenue;
  const grcComp=comp(grcRev,grcPrior);

  h+='<div class="card"><div class="card-t" style="margin-bottom:14px">Key Insights</div>';
  if(whComp>20) h+=`<div class="insight-box insight-green"><strong>Wholesale is driving growth.</strong> House Accounts at ${F.$(whRev)} (${compS(whComp)} YoY)  -  now ${F.p(whRev/totalRev*100)} of total revenue. This channel has overtaken Ecommerce as the primary revenue driver.</div>`;
  if(ecomComp!==null) h+=`<div class="insight-box insight-blue"><strong>Ecommerce ${ecomComp>=0?'holding steady':'softening'}.</strong> ${F.$(ecomRev)} (${compS(ecomComp)} YoY)  -  ${F.p(ecomRev/totalRev*100)} share. ${ecomComp<5?'Consider retention campaigns and AOV optimization.':'Digital channel continues to perform.'}</div>`;
  if(grcComp<0) h+=`<div class="insight-box insight-red"><strong>Grocery channel declining.</strong> ${F.$(grcRev)} (${compS(grcComp)} YoY). Review listing strategy, promotional calendar, and buyer relationships. Shelf position audits recommended.</div>`;
  h+=`<div class="insight-box insight-amber"><strong>Revenue concentration risk.</strong> Top channel (${topCh[0]?topCh[0][0]:''}) is ${F.p(topCh[0]?topCh[0][1].revenue/totalRev*100:0)} of revenue. Industry best practice targets <40% from any single channel for resilience.</div>`;
  h+='</div>';

  // Two columns: Channel donut + Category donut
  h+='<div class="cr">';
  // Channel donut
  const chDonutData=topCh.map(([ch,d],i)=>({label:ch,value:d.revenue,color:COLORS[i%COLORS.length]}));
  h+='<div class="card"><div class="card-t" style="margin-bottom:10px">Revenue by Channel</div><div class="donut-wrap">';
  h+=donut(chDonutData,170);
  h+=`<div class="donut-legend">${donutLegend(chDonutData)}</div>`;
  h+='</div></div>';
  // Category donut
  const catDonutData=catList.slice(0,7).map(([cat,d],i)=>({label:cat,value:d.revenue,color:COLORS[i%COLORS.length]}));
  h+='<div class="card"><div class="card-t" style="margin-bottom:10px">Revenue by Category</div><div class="donut-wrap">';
  h+=donut(catDonutData,170);
  h+=`<div class="donut-legend">${donutLegend(catDonutData)}</div>`;
  h+='</div></div>';
  h+='</div>';

  // Questions for leadership
  h+='<div class="q-box"><div class="q-box-title">Discussion Points for Leadership</div><ul>';
  h+='<li><strong>Channel diversification:</strong> With wholesale at 50%+ of revenue, what is our contingency if a top 3 account churns?</li>';
  h+='<li><strong>Grocery strategy:</strong> Is the declining grocery comp a distribution/listing problem or a velocity/merchandising problem? Do we invest or divest?</li>';
  h+='<li><strong>Ecommerce growth:</strong> What levers exist for digital  -  new customer acquisition, AOV improvement, or repeat purchase rate?</li>';
  h+='<li><strong>Corporate pipeline:</strong> Corporate has high AOV but low order count. What does the Q2/Q3 gifting pipeline look like?</li>';
  h+='<li><strong>New SKU launches:</strong> Are upcoming launches aligned with our fastest-growing channels, or are we developing product for our weakest?</li>';
  h+='<li><strong>Margin visibility:</strong> With our 7-tier cost resolution now covering 99% of revenue, what pricing decisions can we make with confidence that we could not make before?</li>';
  h+='<li><strong>Seasonality planning:</strong> Given the Q1 wholesale front-loading pattern, are we optimizing production schedules and inventory levels to capture this demand without excess carrying cost?</li>';
  h+='</ul></div>';
  return h;
};

// ==================== DASHBOARD ====================
PG.dash=function(){
  var c=D.ytd_cust||[],cp=D.ytd_prior||[];
  var totalRev=c.reduce(function(s,r){return s+r.revenue},0);
  var totalOrd=c.reduce(function(s,r){return s+r.orders},0);
  var priorRev=cp.reduce(function(s,r){return s+r.revenue},0);
  var priorOrd=cp.reduce(function(s,r){return s+r.orders},0);
  var ytdComp=comp(totalRev,priorRev);
  var chData=aggByChannel(c),chPrior=aggByChannel(cp);

  // MTD from daily
  var daily=D.daily||[],now=new Date(),yr=now.getFullYear(),mo=now.getMonth()+1;
  var mtdRev=0,mtdOrd=0,mtdPriorRev=0,mtdPriorOrd=0;
  var dayCount=0;
  daily.forEach(function(r){
    var d=new Date(r.dt);
    if(d.getFullYear()===yr&&d.getMonth()+1===mo){mtdRev+=r.revenue;mtdOrd+=r.orders;dayCount++}
    if(d.getFullYear()===yr-1&&d.getMonth()+1===mo){mtdPriorRev+=r.revenue;mtdPriorOrd+=r.orders}
  });
  var mtdComp=comp(mtdRev,mtdPriorRev);

  // WTD
  var twRev=(D.tw||[]).reduce(function(s,r){return s+r.revenue},0);
  var twOrd=(D.tw||[]).reduce(function(s,r){return s+r.orders},0);
  var lyRev=(D.ly||[]).reduce(function(s,r){return s+r.revenue},0);
  var lyOrd=(D.ly||[]).reduce(function(s,r){return s+r.orders},0);
  var wtdComp=comp(twRev,lyRev);

  // Products/Categories
  var prods=(D.ytd_products||[]).filter(function(p){return!['Subtotal','Shipping','Adjustments'].includes(categorize(p.productNum,p.description))});
  var cats={};prods.forEach(function(p){var cat=categorize(p.productNum,p.description);if(!cats[cat])cats[cat]={revenue:0,count:0};cats[cat].revenue+=p.revenue;cats[cat].count++});
  var catList=Object.entries(cats).filter(function(x){return x[1].revenue>0}).sort(function(a,b){return b[1].revenue-a[1].revenue});
  var catTotal=catList.reduce(function(s,x){return s+x[1].revenue},0);

  var h='<div style="margin-bottom:24px"><div class="page-title">Sales Dashboard</div><div class="page-sub">Fiscal YTD: Jul 27, 2025 - Present</div></div>';

  // === YEAR KPIs ===
  h+='<div style="font-size:11px;font-weight:600;color:var(--txm);text-transform:uppercase;letter-spacing:1px;margin-bottom:8px">Year to Date</div>';
  h+='<div class="kg" style="grid-template-columns:repeat(5,1fr)">';
  h+='<div class="kpi"><div class="kpi-l">YTD Revenue</div><div class="kpi-v">'+F.$m(totalRev)+'</div></div>';
  h+='<div class="kpi"><div class="kpi-l">Prior YTD</div><div class="kpi-v">'+F.$m(priorRev)+'</div></div>';
  h+='<div class="kpi" style="border-color:'+(ytdComp>=0?'var(--gn)':'var(--rd)')+'"><div class="kpi-l">YTD Comp</div><div class="kpi-v">'+compS(ytdComp)+'</div></div>';
  h+='<div class="kpi"><div class="kpi-l">YTD Orders</div><div class="kpi-v">'+F.n(totalOrd)+'</div><div class="kpi-sub">Prior: '+F.n(priorOrd)+'</div></div>';
  h+='<div class="kpi"><div class="kpi-l">Avg Order</div><div class="kpi-v">'+F.$(totalRev/totalOrd)+'</div></div>';
  h+='</div>';

  // === MONTH KPIs ===
  h+='<div style="font-size:11px;font-weight:600;color:var(--txm);text-transform:uppercase;letter-spacing:1px;margin:16px 0 8px">Month to Date</div>';
  h+='<div class="kg" style="grid-template-columns:repeat(5,1fr)">';
  h+='<div class="kpi"><div class="kpi-l">MTD Revenue</div><div class="kpi-v">'+F.$f(mtdRev)+'</div></div>';
  h+='<div class="kpi"><div class="kpi-l">Prior Year MTD</div><div class="kpi-v">'+F.$f(mtdPriorRev)+'</div></div>';
  h+='<div class="kpi" style="border-color:'+(mtdComp>=0?'var(--gn)':'var(--rd)')+'"><div class="kpi-l">MTD Comp</div><div class="kpi-v">'+(mtdPriorRev>0?compS(mtdComp):'-')+'</div></div>';
  h+='<div class="kpi"><div class="kpi-l">MTD Orders</div><div class="kpi-v">'+F.n(mtdOrd)+'</div><div class="kpi-sub">Prior: '+F.n(mtdPriorOrd)+'</div></div>';
  h+='<div class="kpi"><div class="kpi-l">MTD Avg Order</div><div class="kpi-v">'+(mtdOrd>0?F.$(mtdRev/mtdOrd):'-')+'</div></div>';
  h+='</div>';

  // === WEEK KPIs ===
  h+='<div style="font-size:11px;font-weight:600;color:var(--txm);text-transform:uppercase;letter-spacing:1px;margin:16px 0 8px">Week to Date</div>';
  h+='<div class="kg" style="grid-template-columns:repeat(5,1fr)">';
  h+='<div class="kpi"><div class="kpi-l">WTD Revenue</div><div class="kpi-v">'+F.$f(twRev)+'</div></div>';
  h+='<div class="kpi"><div class="kpi-l">Same Week LY</div><div class="kpi-v">'+F.$f(lyRev)+'</div></div>';
  h+='<div class="kpi" style="border-color:'+(wtdComp>=0?'var(--gn)':'var(--rd)')+'"><div class="kpi-l">WTD vs LY</div><div class="kpi-v">'+(lyRev>0?compS(wtdComp):'-')+'</div></div>';
  h+='<div class="kpi"><div class="kpi-l">WTD Orders</div><div class="kpi-v">'+F.n(twOrd)+'</div><div class="kpi-sub">LY: '+F.n(lyOrd)+'</div></div>';
  h+='<div class="kpi"><div class="kpi-l">WTD Avg Order</div><div class="kpi-v">'+(twOrd>0?F.$(twRev/twOrd):'-')+'</div></div>';
  h+='</div>';

  // === AOV by Channel ===
  var chSorted=Object.entries(chData).sort(function(a,b){return b[1].revenue-a[1].revenue});
  h+='<div style="font-size:11px;font-weight:600;color:var(--txm);text-transform:uppercase;letter-spacing:1px;margin:16px 0 8px">AOV by Channel</div>';
  h+='<div class="kg" style="grid-template-columns:repeat('+Math.min(chSorted.length,6)+',1fr)">';
  chSorted.forEach(function(x,i){
    var ch=x[0],d=x[1],aov=d.orders>0?d.revenue/d.orders:0;
    h+='<div class="kpi" style="border-left:3px solid '+COLORS[i%COLORS.length]+'"><div class="kpi-l">'+ch+'</div><div class="kpi-v">'+F.$(aov)+'</div><div class="kpi-sub">'+F.n(d.orders)+' orders</div></div>';
  });
  h+='</div>';

  // Channel table
  h+='<div class="card"><div class="card-hd"><div class="card-t">YTD by Channel</div><button class="xb" onclick="xT(\'chtop\')">Export</button></div>';
  h+='<table class="dt" id="chtop"><thead><tr><th>Channel</th><th class="n">Revenue</th><th class="n">Orders</th><th class="n">Share</th><th class="n">Avg Order</th></tr></thead><tbody>';
  chSorted.forEach(function(x){
    var ch=x[0],d=x[1];
    h+='<tr><td style="font-weight:500">'+badgeCh(ch)+' '+ch+'</td><td class="n">'+F.$f(d.revenue)+'</td><td class="n">'+F.n(d.orders)+'</td><td class="n">'+F.p(d.revenue/totalRev*100)+'</td><td class="n">'+F.$f(d.revenue/d.orders)+'</td></tr>';
  });
  h+='</tbody></table></div>';

  // Two columns
  h+='<div class="cr">';
  var top=c.slice().sort(function(a,b){return b.revenue-a.revenue}).slice(0,20);
  h+='<div class="card"><div class="card-hd"><div class="card-t">Top 20 Customers</div><button class="xb" onclick="xT(\'t20\')">Export</button></div>';
  h+='<div style="max-height:500px;overflow-y:auto"><table class="dt" id="t20"><thead><tr><th>#</th><th>Customer</th><th>Channel</th><th class="n">Revenue</th><th class="n">Orders</th></tr></thead><tbody>';
  top.forEach(function(r,i){h+='<tr><td style="color:var(--txd)">'+(i+1)+'</td><td>'+r.customer+'</td><td>'+badgeCh(classify(r.customer))+'</td><td class="n">'+F.$f(r.revenue)+'</td><td class="n">'+F.n(r.orders)+'</td></tr>'});
  h+='</tbody></table></div></div>';

  var catDonutData=catList.slice(0,7).map(function(x,i){return{label:x[0],value:x[1].revenue,color:COLORS[i%COLORS.length]}});
  h+='<div class="card"><div class="card-hd"><div class="card-t">Revenue by Category</div><button class="xb" onclick="xT(\'catd\')">Export</button></div>';
  h+='<div class="donut-wrap" style="margin-bottom:12px">'+donut(catDonutData,140)+'<div class="donut-legend">'+donutLegend(catDonutData)+'</div></div>';
  h+='<table class="dt" id="catd"><thead><tr><th>Category</th><th class="n">Revenue</th><th class="n">Share</th><th class="n">SKUs</th></tr></thead><tbody>';
  catList.forEach(function(x){h+='<tr><td style="font-weight:500">'+x[0]+'</td><td class="n">'+F.$f(x[1].revenue)+'</td><td class="n">'+F.p(x[1].revenue/catTotal*100)+'</td><td class="n">'+x[1].count+'</td></tr>'});
  h+='</tbody></table></div></div>';
  
  return h;
};



// ==================== WEEKLY PULSE ====================
PG.pulse=function(){
  const chs=['Corporate','Ecommerce','Grocery','POS','Wholesale: DYA','Wholesale: House Account'];
  const twCh=aggByChannel(D.tw),lwCh=aggByChannel(D.lw),lyCh=aggByChannel(D.ly);
  const ytdCCh=aggByChannel(D.ytd_cust),ytdPCh=aggByChannel(D.ytd_prior);
  const g=(obj,ch)=>obj[ch]||{revenue:0,orders:0};
  const atr=(r,o)=>o>0?F.$(r/o):'-';
  let ttw=0,tlw=0,tly=0;
  let rows='';
  for(const ch of chs){const tw=g(twCh,ch),lw=g(lwCh,ch),ly=g(lyCh,ch);const twC=comp(tw.revenue,ly.revenue);ttw+=tw.revenue;tlw+=lw.revenue;tly+=ly.revenue;rows+=`<tr><td style="font-weight:500">${badgeCh(ch)}</td><td class="n">${F.$(tw.revenue)}</td><td class="n">${F.$(lw.revenue)}</td><td class="n">${F.$(ly.revenue)}</td><td class="n">${compS(twC)}</td><td class="n">${tw.orders}</td></tr>`}
  const wk=D.weeks||{};

  // Trailing 4 weeks
  const trailing=getWeeklyTrailing(5);
  const avgTrail=trailing.length>1?trailing.slice(1).reduce((s,w)=>s+w.revenue,0)/(trailing.length-1):0;

  let h=`<div style="margin-bottom:24px"><div class="page-title">Weekly Sales Pulse</div><div class="page-sub">TW: ${wk.tw?.label||''}</div></div>`;
  h+='<div class="kg" style="grid-template-columns:repeat(5,1fr)">';
  h+=`<div class="kpi"><div class="kpi-l">This Week</div><div class="kpi-v">${F.$(ttw)}</div></div>`;
  h+=`<div class="kpi"><div class="kpi-l">Last Week</div><div class="kpi-v">${F.$(tlw)}</div></div>`;
  h+=`<div class="kpi"><div class="kpi-l">Same Week LY</div><div class="kpi-v">${F.$(tly)}</div></div>`;
  h+=`<div class="kpi" style="border-color:${comp(ttw,tly)>=0?'var(--gn)':'var(--rd)'}"><div class="kpi-l">TW vs LY</div><div class="kpi-v">${compS(comp(ttw,tly))}</div></div>`;
  h+=`<div class="kpi" style="border-color:var(--purple)"><div class="kpi-l">Next Week Est.</div><div class="kpi-v" style="color:var(--purple)">${F.$(avgTrail)}</div><div class="kpi-sub">4-wk avg</div></div>`;
  h+='</div>';

  // Channel table
  h+='<div class="card"><div class="card-hd"><div class="card-t">This Week by Channel</div><button class="xb" onclick="xT(\'wpt\')">Export</button></div>';
  h+='<table class="dt" id="wpt"><thead><tr><th>Channel</th><th class="n">This Week</th><th class="n">Last Week</th><th class="n">Same Wk LY</th><th class="n">TW vs LY</th><th class="n">Orders</th></tr></thead><tbody>';
  h+=rows;
  h+=`<tr style="font-weight:700;border-top:2px solid var(--ac)"><td>TOTAL</td><td class="n">${F.$(ttw)}</td><td class="n">${F.$(tlw)}</td><td class="n">${F.$(tly)}</td><td class="n">${compS(comp(ttw,tly))}</td><td class="n">${(D.tw||[]).reduce((s,r)=>s+r.orders,0)}</td></tr>`;
  h+='</tbody></table></div>';

  // Trailing 4 weeks
  h+='<div class="card"><div class="card-t" style="margin-bottom:14px">Trailing 5 Weeks</div>';
  h+='<table class="dt"><thead><tr><th>Week</th><th class="n">Revenue</th><th class="n">Orders</th><th class="n">vs Prior Wk</th></tr></thead><tbody>';
  trailing.forEach((w,i)=>{
    const prev=trailing[i+1];const wComp=prev&&prev.revenue>0?comp(w.revenue,prev.revenue):null;
    h+=`<tr${i===0?' style="background:var(--acl)"':''}><td style="font-weight:${i===0?'700':'400'}">${i===0?'This Week':w.label}</td><td class="n">${F.$(w.revenue)}</td><td class="n">${F.n(w.orders)}</td><td class="n">${compS(wComp)}</td></tr>`;
  });
  h+='</tbody></table></div>';
  return h;
};

// ==================== COMP % ====================
PG.comp=function(){
  const ytdC=D.ytd_cust||[],ytdP=D.ytd_prior||[];
  const totalYc=ytdC.reduce((s,r)=>s+r.revenue,0),totalYp=ytdP.reduce((s,r)=>s+r.revenue,0);
  const totalComp=comp(totalYc,totalYp);
  const ytdCCh=aggByChannel(ytdC),ytdPCh=aggByChannel(ytdP);

  let h='<div style="margin-bottom:24px"><div class="page-title">Comp % Analysis</div></div>';
  h+='<div class="kg" style="grid-template-columns:repeat(4,1fr)">';
  h+=`<div class="kpi"><div class="kpi-l">YTD 25/26</div><div class="kpi-v">${F.$m(totalYc)}</div></div>`;
  h+=`<div class="kpi"><div class="kpi-l">YTD 24/25</div><div class="kpi-v">${F.$m(totalYp)}</div></div>`;
  h+=`<div class="kpi" style="border-color:${totalComp>=0?'var(--gn)':'var(--rd)'}"><div class="kpi-l">YTD Comp</div><div class="kpi-v">${compS(totalComp)}</div></div>`;
  h+=`<div class="kpi"><div class="kpi-l">$ Growth</div><div class="kpi-v" style="color:${(totalYc-totalYp)>=0?'var(--gn)':'var(--rd)'}">${F.$(totalYc-totalYp)}</div></div>`;
  h+='</div>';

  // Best-in-class benchmarks
  h+='<div class="card"><div class="card-t" style="margin-bottom:14px">Benchmark: Best-in-Class Omnichannel Specialty Food</div>';
  h+='<div class="insight-box insight-purple"><strong>Industry context:</strong> Best-in-class specialty food brands (similar scale, multi-channel DTC+wholesale) typically target 15-25% annual revenue growth, with healthy channel mix of ~35% DTC, ~40% wholesale, ~15% grocery, ~10% corporate/other. Kanel\'s +27% comp is above the high end of this range.</div>';
  h+='<table class="dt"><thead><tr><th>Metric</th><th class="n">Kanel Actual</th><th class="n">Best-in-Class Target</th><th class="n">Assessment</th></tr></thead><tbody>';
  h+=`<tr><td>Annual Revenue Growth</td><td class="n">${compS(totalComp)}</td><td class="n">15-25%</td><td class="n"><span class="pos">Above Target</span></td></tr>`;
  const ecomShare=(ytdCCh['Ecommerce']||{revenue:0}).revenue/totalYc*100;
  h+=`<tr><td>DTC (Ecom+POS) Share</td><td class="n">${F.p(ecomShare+((ytdCCh['POS']||{revenue:0}).revenue/totalYc*100))}</td><td class="n">30-40%</td><td class="n">${ecomShare>25?'<span class="pos">Healthy</span>':'<span class="neg">Below Target</span>'}</td></tr>`;
  const avgOrd=totalYc/(ytdC.reduce((s,r)=>s+r.orders,0)||1);
  h+=`<tr><td>Average Order Value</td><td class="n">${F.$(avgOrd)}</td><td class="n">$150-$300</td><td class="n">${avgOrd>150?'<span class="pos">Strong</span>':'<span class="neg">Room to Grow</span>'}</td></tr>`;
  const top10pct=ytdC.slice().sort((a,b)=>b.revenue-a.revenue).slice(0,Math.ceil(ytdC.length*0.1)).reduce((s,r)=>s+r.revenue,0)/totalYc*100;
  h+=`<tr><td>Top 10% Customer Concentration</td><td class="n">${F.p(top10pct)}</td><td class="n">&lt;60%</td><td class="n">${top10pct<60?'<span class="pos">Diversified</span>':'<span class="neg">Concentrated</span>'}</td></tr>`;
  h+='</tbody></table>';
  h+='<div style="margin-top:12px;font-size:12px;color:var(--txm)">Benchmarks based on specialty food brands at $5M-$25M revenue across DTC, wholesale, grocery channels (Specialty Food Association data)</div></div>';

  // Channel comp table
  const allCh=[...new Set([...Object.keys(ytdCCh),...Object.keys(ytdPCh)])].sort();
  h+='<div class="card"><div class="card-hd"><div class="card-t">Channel YTD Comp</div><button class="xb" onclick="xT(\'chcomp\')">Export</button></div>';
  h+='<table class="dt" id="chcomp"><thead><tr><th>Channel</th><th class="n">YTD 25/26</th><th class="n">YTD 24/25</th><th class="n">Comp %</th><th class="n">$ Change</th></tr></thead><tbody>';
  allCh.forEach(ch=>{const c=(ytdCCh[ch]||{revenue:0}).revenue,p=(ytdPCh[ch]||{revenue:0}).revenue;h+=`<tr><td style="font-weight:500">${ch}</td><td class="n">${F.$f(c)}</td><td class="n">${F.$f(p)}</td><td class="n">${compS(comp(c,p))}</td><td class="n" style="color:${(c-p)>=0?'var(--gn)':'var(--rd)'}">$${Math.abs(c-p).toLocaleString('en-US',{maximumFractionDigits:0})}</td></tr>`});
  h+='</tbody></table></div>';

  // Monthly comp
  const byMo={};(D.monthly||[]).forEach(r=>{byMo[r.yr+'-'+String(r.mo).padStart(2,'0')]=r.revenue});
  const moComp=[];Object.keys(byMo).sort().forEach(k=>{const[y,m]=k.split('-').map(Number);const lyK=(y-1)+'-'+String(m).padStart(2,'0');if(byMo[lyK]!==undefined)moComp.push({month:F.mo(m)+' '+y,current:byMo[k],prior:byMo[lyK],comp:comp(byMo[k],byMo[lyK])})});
  h+='<div class="card"><div class="card-hd"><div class="card-t">Monthly YoY Comp</div><button class="xb" onclick="xT(\'mocomp\')">Export</button></div>';
  h+='<table class="dt" id="mocomp"><thead><tr><th>Month</th><th class="n">Current</th><th class="n">Prior Year</th><th class="n">Comp %</th><th class="n">$ Change</th></tr></thead><tbody>';
  moComp.reverse().forEach(r=>{h+=`<tr><td>${r.month}</td><td class="n">${F.$f(r.current)}</td><td class="n">${F.$f(r.prior)}</td><td class="n">${compS(r.comp)}</td><td class="n" style="color:${(r.current-r.prior)>=0?'var(--gn)':'var(--rd)'}">$${Math.abs(r.current-r.prior).toLocaleString('en-US',{maximumFractionDigits:0})}</td></tr>`});
  h+='</tbody></table></div>';

  // Gainers/Decliners
  const cy=D.cust_yearly||[];const custByYr={};cy.forEach(r=>{if(!custByYr[r.customer])custByYr[r.customer]={};custByYr[r.customer][r.yr]=r.revenue});
  const years=[...new Set(cy.map(r=>r.yr))].sort();const lY=years[years.length-1],pY=years[years.length-2];
  const custComp=[];Object.entries(custByYr).forEach(([name,yrs])=>{const c=yrs[lY]||0,p=yrs[pY]||0;if(c>0||p>0)custComp.push({customer:name,current:c,prior:p,comp:comp(c,p),delta:c-p,channel:classify(name)})});
  const up=custComp.filter(c=>c.delta>500).sort((a,b)=>b.delta-a.delta).slice(0,20);
  const down=custComp.filter(c=>c.delta<-500).sort((a,b)=>a.delta-b.delta).slice(0,20);

  h+='<div class="cr">';
  h+='<div class="card"><div class="card-hd"><div class="card-t" style="color:var(--gn)">â² Top Gainers</div><button class="xb" onclick="xT(\'cup\')">Export</button></div><div style="max-height:500px;overflow-y:auto"><table class="dt" id="cup"><thead><tr><th>#</th><th>Customer</th><th class="n">Current</th><th class="n">Prior</th><th class="n">$ Change</th></tr></thead><tbody>';
  up.forEach((c,i)=>{h+=`<tr><td style="color:var(--txd)">${i+1}</td><td>${c.customer}</td><td class="n">${F.$f(c.current)}</td><td class="n">${F.$f(c.prior)}</td><td class="n pos">+${F.$f(c.delta)}</td></tr>`});
  h+='</tbody></table></div></div>';
  h+='<div class="card"><div class="card-hd"><div class="card-t" style="color:var(--rd)">â¼ Top Decliners</div><button class="xb" onclick="xT(\'cdn\')">Export</button></div><div style="max-height:500px;overflow-y:auto"><table class="dt" id="cdn"><thead><tr><th>#</th><th>Customer</th><th class="n">Current</th><th class="n">Prior</th><th class="n">$ Change</th></tr></thead><tbody>';
  down.forEach((c,i)=>{h+=`<tr><td style="color:var(--txd)">${i+1}</td><td>${c.customer}</td><td class="n">${F.$f(c.current)}</td><td class="n">${F.$f(c.prior)}</td><td class="n neg">${F.$f(c.delta)}</td></tr>`});
  h+='</tbody></table></div></div></div>';
  return h;
};

// ==================== CHANNEL ====================
PG.chan=function(){
  const cy=D.cust_yearly||[];const chYr={};cy.forEach(r=>{const ch=classify(r.customer);const k=ch+'|'+r.yr;if(!chYr[k])chYr[k]={revenue:0,orders:0};chYr[k].revenue+=r.revenue;chYr[k].orders+=r.orders});
  const years=[...new Set(cy.map(r=>r.yr))].sort();const channels=[...new Set(cy.map(r=>classify(r.customer)))];
  const sorted=channels.sort((a,b)=>{const la=(chYr[a+'|'+years[years.length-1]]||{revenue:0}).revenue,lb=(chYr[b+'|'+years[years.length-1]]||{revenue:0}).revenue;return lb-la});

  let h='<div style="margin-bottom:24px"><div class="page-title">Channel Analysis</div><div class="page-sub">Calendar year comparison</div></div>';

  // Insight: why is 2026 already so high
  const latestYr=years[years.length-1];const priorYr=years[years.length-2];
  const totLatest=channels.reduce((s,ch)=>s+(chYr[ch+'|'+latestYr]||{revenue:0}).revenue,0);
  const totPrior=channels.reduce((s,ch)=>s+(chYr[ch+'|'+priorYr]||{revenue:0}).revenue,0);
  
  h+=`<div class="insight-box insight-blue"><strong>Why does ${latestYr} already look so high?</strong> The ${latestYr} column shows calendar year-to-date (Jan ${latestYr} to today). At ${F.$m(totLatest)} with only ~2 months elapsed, the daily run rate is ${F.$(totLatest/55)}  -  annualizing to ~${F.$m(totLatest/55*365)}. The prior full year was ${F.$m(totPrior)}. The key driver is wholesale order timing  -  large accounts front-load spring inventory in Jan/Feb, inflating early YTD numbers.</div>`;

  h+='<div class="card"><div class="card-hd"><div class="card-t">Channel Revenue by Year</div><button class="xb" onclick="xT(\'chtbl\')">Export</button></div>';
  h+='<table class="dt" id="chtbl"><thead><tr><th>Channel</th>';years.forEach(y=>{h+=`<th class="n">${y}</th>`});h+='<th class="n">YoY</th></tr></thead><tbody>';
  const tots=years.map(()=>0);
  sorted.forEach(ch=>{h+=`<tr><td style="font-weight:500">${ch}</td>`;years.forEach((y,i)=>{const v=(chYr[ch+'|'+y]||{revenue:0}).revenue;tots[i]+=v;h+=`<td class="n">${F.$f(v)}</td>`});const v1=(chYr[ch+'|'+latestYr]||{revenue:0}).revenue,v0=(chYr[ch+'|'+priorYr]||{revenue:0}).revenue;h+=`<td class="n">${compS(comp(v1,v0))}</td></tr>`});
  h+='<tr style="font-weight:700;border-top:2px solid var(--ac)"><td>TOTAL</td>';tots.forEach(v=>{h+=`<td class="n">${F.$f(v)}</td>`});h+=`<td class="n">${compS(comp(tots[tots.length-1],tots[tots.length-2]))}</td></tr></tbody></table></div>`;

  // Channel donut for latest year
  const chDonut=sorted.map((ch,i)=>({label:ch,value:(chYr[ch+'|'+latestYr]||{revenue:0}).revenue,color:COLORS[i%COLORS.length]}));
  h+='<div class="card"><div class="card-t" style="margin-bottom:10px">'+latestYr+' Channel Mix</div><div class="donut-wrap">'+donut(chDonut,160)+'<div class="donut-legend">'+donutLegend(chDonut)+'</div></div></div>';
  
  // Channel Intelligence
  h+='<div class="card"><div class="card-t" style="margin-bottom:14px">Channel Intelligence</div>';
  
  h+='<div class="insight-box insight-blue"><strong>Channel health framework:</strong> A balanced specialty food brand should target approximately 30-35% DTC (highest margin), 35-40% Wholesale (volume driver), 15-20% Grocery (reach and brand awareness), 10% Corporate/Other (seasonal upside). Deviations from this mix should be deliberate strategic choices, not drift.</div>';
  
  h+='<div class="insight-box insight-amber"><strong>Channel conflict risk:</strong> As wholesale grows, are retail partners seeing the same products at lower prices online? Consider channel-exclusive SKUs or size variants to protect wholesale relationships while maintaining DTC margins.</div>';
  
  h+='<div class="q-box"><div class="q-box-title">Channel Strategy Questions</div><ul>';
  h+='<li><strong>DTC acquisition cost:</strong> What is our customer acquisition cost per channel? Is DTC growth driven by paid media (expensive) or organic/repeat (sustainable)?</li>';
  h+='<li><strong>Wholesale margin by account:</strong> Not all wholesale accounts are equally profitable. Which accounts justify the lower margin through volume, and which are margin-destructive?</li>';
  h+='<li><strong>Grocery velocity:</strong> What are our units per store per week across grocery partners? Are we at risk of delisting in any banners?</li>';
  h+='<li><strong>Corporate gifting pipeline:</strong> Corporate orders are seasonal and high-AOV. What is our Q2-Q3 pipeline? Are we proactively selling into the gifting season?</li>';
  h+='</ul></div>';
  h+='</div>';
  
  return h;
};

// ==================== CATEGORY ====================
PG.cat=function(){
  const prods=(D.ytd_products||[]).map(p=>({...p,category:categorize(p.productNum,p.description)})).filter(p=>!['Subtotal','Shipping','Adjustments'].includes(p.category));
  const cats={};prods.forEach(p=>{if(!cats[p.category])cats[p.category]={revenue:0,qty:0,count:0};cats[p.category].revenue+=p.revenue;cats[p.category].qty+=p.qty;cats[p.category].count++});
  const catList=Object.entries(cats).filter(([k,v])=>v.revenue>0).sort((a,b)=>b[1].revenue-a[1].revenue);
  const total=catList.reduce((s,[k,v])=>s+v.revenue,0);

  let h='<div style="margin-bottom:24px"><div class="page-title">Category Performance</div><div class="page-sub">Fiscal YTD</div></div>';
  h+='<div class="kg">';catList.slice(0,6).forEach(([cat,d],i)=>{h+=`<div class="kpi"><div class="kpi-l">${cat}</div><div class="kpi-v" style="color:${COLORS[i]}">${F.$(d.revenue)}</div><div class="kpi-sub">${F.p(d.revenue/total*100)} share Â· ${d.count} SKUs</div></div>`});h+='</div>';

  const catDonut=catList.slice(0,7).map(([cat,d],i)=>({label:cat,value:d.revenue,color:COLORS[i%COLORS.length]}));
  h+='<div class="card"><div class="card-t" style="margin-bottom:10px">Category Mix</div><div class="donut-wrap">'+donut(catDonut,160)+'<div class="donut-legend">'+donutLegend(catDonut)+'</div></div></div>';

  h+='<div class="card"><div class="card-hd"><div class="card-t">All Categories</div><button class="xb" onclick="xT(\'cattbl\')">Export</button></div>';
  h+='<table class="dt" id="cattbl"><thead><tr><th>Category</th><th class="n">Revenue</th><th class="n">Share</th><th class="n">Qty</th><th class="n">SKUs</th><th class="n">Rev/SKU</th></tr></thead><tbody>';
  catList.forEach(([cat,d])=>{h+=`<tr><td style="font-weight:500">${cat}</td><td class="n">${F.$f(d.revenue)}</td><td class="n">${F.p(d.revenue/total*100)}</td><td class="n">${F.n(d.qty)}</td><td class="n">${d.count}</td><td class="n">${F.$f(d.revenue/d.count)}</td></tr>`});
  h+='</tbody></table></div>';

  // Category Insights
  h+='<div class="card"><div class="card-t" style="margin-bottom:14px">Category Intelligence</div>';
  
  if(catList.length>0){
    var topCat=catList[0];
    var topCatPct=topCat[1].revenue/total*100;
    h+='<div class="insight-box insight-blue"><strong>'+topCat[0]+' dominates at '+F.p(topCatPct)+' of revenue.</strong> '+(topCatPct>40?'This is high concentration in a single category. A supply disruption or trend shift in this category would significantly impact total revenue. Consider strategies to grow secondary categories.':'Healthy distribution across categories.')+'</div>';
  }
  
  // SKU efficiency
  catList.forEach(function(x){
    var cat=x[0],d=x[1];
    var revPerSku=d.count>0?d.revenue/d.count:0;
    if(d.count>5&&revPerSku<500){
      h+='<div class="insight-box insight-amber"><strong>'+cat+' has low revenue per SKU ('+F.$(revPerSku)+').</strong> With '+d.count+' SKUs generating '+F.$(d.revenue)+' total, consider whether the full assortment is needed. Each SKU carries inventory, complexity, and operational cost.</div>';
    }
  });
  
  h+='</div>';
  
  return h;
};

// ==================== SKU PERFORMANCE ====================
PG.sku=function(){
  const prods=(D.ytd_products||[]).map(p=>({...p,category:categorize(p.productNum,p.description)})).filter(p=>!['Subtotal','Shipping','Adjustments'].includes(p.category)&&p.revenue>0).sort((a,b)=>b.revenue-a.revenue);
  const total=prods.reduce((s,x)=>s+x.revenue,0);
  const top20Rev=prods.slice(0,20).reduce((s,x)=>s+x.revenue,0);
  const top80pct=prods.findIndex((p,i)=>{let c=0;for(let j=0;j<=i;j++)c+=prods[j].revenue;return c/total>=0.8})+1;

  let h='<div style="margin-bottom:24px"><div class="page-title">SKU Performance</div><div class="page-sub">'+prods.length+' active products  -  Fiscal YTD</div></div>';

  h+='<div class="kg" style="grid-template-columns:repeat(4,1fr)">';
  h+=`<div class="kpi"><div class="kpi-l">Total Revenue</div><div class="kpi-v">${F.$m(total)}</div></div>`;
  h+=`<div class="kpi"><div class="kpi-l">Active SKUs</div><div class="kpi-v">${prods.length}</div></div>`;
  h+=`<div class="kpi"><div class="kpi-l">Top 20 SKUs</div><div class="kpi-v">${F.p(top20Rev/total*100)}</div><div class="kpi-sub">of total revenue</div></div>`;
  h+=`<div class="kpi" style="border-color:var(--purple)"><div class="kpi-l">80% Revenue</div><div class="kpi-v" style="color:var(--purple)">${top80pct} SKUs</div><div class="kpi-sub">out of ${prods.length}</div></div>`;
  h+='</div>';

  h+=`<div class="insight-box insight-purple"><strong>Pareto Analysis:</strong> ${top80pct} SKUs (${F.p(top80pct/prods.length*100)} of catalog) drive 80% of revenue. The remaining ${prods.length-top80pct} SKUs generate only 20%. Consider rationalizing the long tail  -  each low-velocity SKU carries inventory cost, warehouse space, and operational complexity.</div>`;

  // Top 20 with cumulative %
  h+='<div class="card"><div class="card-hd"><div class="card-t">Top 20 Revenue Drivers</div></div>';
  h+='<table class="dt"><thead><tr><th>#</th><th>Product</th><th>Category</th><th class="n">Revenue</th><th class="n">Share</th><th class="n">Qty</th></tr></thead><tbody>';
  prods.slice(0,20).forEach((x,i)=>{h+=`<tr><td style="color:var(--txd)">${i+1}</td><td>${(x.description||'').substring(0,50)}</td><td>${badgeCh(x.category||'Other')}</td><td class="n">${F.$f(x.revenue)}</td><td class="n">${F.p(x.revenue/total*100)}</td><td class="n">${F.n(x.qty)}</td></tr>`});
  h+='</tbody></table></div>';

  // Bottom performers
  const bottom=prods.filter(p=>p.revenue>0&&p.revenue<100).sort((a,b)=>a.revenue-b.revenue).slice(0,15);
  if(bottom.length>0){
    h+=`<div class="insight-box insight-amber"><strong>Long tail alert:</strong> ${bottom.length}+ SKUs generating under $100 YTD. These represent potential candidates for discontinuation or bundling into collections.</div>`;
  }

  // Full table
  h+='<div class="card"><div class="card-hd"><div class="card-t">All Products</div><button class="xb" onclick="xT(\'skutbl\')">Export</button></div>';
  h+='<div style="max-height:600px;overflow-y:auto"><table class="dt" id="skutbl"><thead><tr><th>#</th><th>Product</th><th>Category</th><th class="n">Revenue</th><th class="n">Share</th><th class="n">Cumul %</th><th class="n">Qty</th></tr></thead><tbody>';
  let cumul=0;prods.forEach((x,i)=>{cumul+=x.revenue;h+=`<tr><td style="color:var(--txd)">${i+1}</td><td>${(x.description||'').substring(0,50)}</td><td><span class="badge badge-who">${x.category||''}</span></td><td class="n">${F.$f(x.revenue)}</td><td class="n">${F.p(x.revenue/total*100)}</td><td class="n">${F.p(cumul/total*100)}</td><td class="n">${F.n(x.qty)}</td></tr>`});
  h+='</tbody></table></div></div>';
  
  
  // SKU Intelligence
  h+='<div class="card"><div class="card-t" style="margin-bottom:14px">SKU Intelligence</div>';
  
  var highVelocity=prods.filter(function(p){return p.qty>500}).length;
  var medVelocity=prods.filter(function(p){return p.qty>=100&&p.qty<=500}).length;
  var lowVelocity=prods.filter(function(p){return p.qty>0&&p.qty<100}).length;
  
  h+='<div class="insight-box insight-blue"><strong>Velocity breakdown:</strong> '+highVelocity+' high-velocity SKUs (500+ units), '+medVelocity+' medium (100-500), '+lowVelocity+' low (<100). Low-velocity SKUs should be evaluated for bundling, promotion, or rationalization.</div>';
  
  var totalQtyAll=prods.reduce(function(s,p){return s+p.qty},0);
  var avgRevPerUnit=totalQtyAll>0?(total/totalQtyAll):0;
  h+='<div class="insight-box insight-purple"><strong>Average revenue per unit: '+F.$(avgRevPerUnit)+'.</strong> This metric is your blended price point across all channels and products. Track this monthly. If it declines, you are either discounting more, shifting mix toward lower-priced items, or wholesale is growing faster than DTC.</div>';
  
  h+='<div class="q-box"><div class="q-box-title">Product Strategy Questions</div><ul>';
  h+='<li><strong>Long tail cost:</strong> What is the true cost of carrying '+lowVelocity+' low-velocity SKUs? Include warehouse space, picking complexity, inventory capital, and spoilage risk.</li>';
  h+='<li><strong>New product development:</strong> Are new launches growing faster than legacy products? What is our hit rate on new SKU introductions?</li>';
  h+='<li><strong>Bundle strategy:</strong> Which low-velocity products could be bundled into collections to increase their sell-through rate?</li>';
  h+='<li><strong>Seasonality by SKU:</strong> Which products have seasonal demand patterns that should drive production and inventory planning?</li>';
  h+='</ul></div>';
  h+='</div>';
  
return h;
};



// ==================== YOY TRENDS ====================
PG.yoy=function(){
  const byYM={};(D.monthly||[]).forEach(r=>{byYM[r.yr+'-'+String(r.mo).padStart(2,'0')]=r});
  const years=[...new Set((D.monthly||[]).map(r=>r.yr))].sort();
  let h='<div style="margin-bottom:24px"><div class="page-title">Year-over-Year Trends</div></div>';
  h+='<div class="card"><div class="card-hd"><div class="card-t">Monthly Revenue</div><button class="xb" onclick="xT(\'yoytbl\')">Export</button></div>';
  h+='<table class="dt" id="yoytbl"><thead><tr><th>Month</th>';years.forEach(y=>{h+=`<th class="n">${y}</th>`});h+='<th class="n">YoY</th></tr></thead><tbody>';
  [1,2,3,4,5,6,7,8,9,10,11,12].forEach(m=>{h+=`<tr><td>${F.mo(m)}</td>`;let vals=[];years.forEach(y=>{const k=y+'-'+String(m).padStart(2,'0');const v=byYM[k]?byYM[k].revenue:null;vals.push(v);h+=`<td class="n">${v!==null?F.$f(v):'-'}</td>`});const yoy=vals.length>=2&&vals[vals.length-1]!==null&&vals[vals.length-2]!==null?comp(vals[vals.length-1],vals[vals.length-2]):null;h+=`<td class="n">${compS(yoy)}</td></tr>`});
  h+='</tbody></table></div>';
  
  // YoY Insights
  h+='<div class="card"><div class="card-t" style="margin-bottom:14px">Trend Intelligence</div>';
  
  // Seasonal pattern detection
  var moRevs={};
  (D.monthly||[]).forEach(function(r){
    if(!moRevs[r.mo])moRevs[r.mo]=[];
    moRevs[r.mo].push(r.revenue);
  });
  
  var peakMonth=0,peakAvg=0;
  Object.keys(moRevs).forEach(function(mo){
    var avg=moRevs[mo].reduce(function(s,v){return s+v},0)/moRevs[mo].length;
    if(avg>peakAvg){peakAvg=avg;peakMonth=parseInt(mo);}
  });
  
  if(peakMonth>0){
    h+='<div class="insight-box insight-blue"><strong>Historical peak month: '+F.mo(peakMonth)+'</strong> with average monthly revenue of '+F.$(peakAvg)+'. Understanding seasonal patterns is critical for production planning, inventory management, and marketing calendar alignment.</div>';
  }
  
  h+='<div class="insight-box insight-purple"><strong>Growth trajectory analysis:</strong> Compare recent months against the same period last year. Sustained positive comps indicate structural growth (new accounts, better distribution). Volatile comps suggest dependence on one-time events (large corporate orders, promotions, new listings).</div>';
  
  h+='</div>';
  
  return h;
};

// ==================== WHOLESALE ====================
PG.who=function(){
  const all=(D.ytd_cust||[]).filter(r=>!r.customer.toLowerCase().includes('shopify')).sort((a,b)=>b.revenue-a.revenue);
  const total=all.reduce((s,r)=>s+r.revenue,0);
  let h='<div style="margin-bottom:24px"><div class="page-title">Wholesale Accounts</div><div class="page-sub">'+all.length+' non-Shopify accounts  -  Fiscal YTD</div></div>';
  h+='<div class="card"><div class="card-hd"><div class="card-t">All Accounts</div><button class="xb" onclick="xT(\'whotbl\')">Export</button></div>';
  h+='<div style="max-height:700px;overflow-y:auto"><table class="dt" id="whotbl"><thead><tr><th>#</th><th>Account</th><th>Channel</th><th class="n">Revenue</th><th class="n">Share</th><th class="n">Orders</th><th class="n">Avg Order</th></tr></thead><tbody>';
  all.forEach((c,i)=>{h+=`<tr><td style="color:var(--txd)">${i+1}</td><td>${c.customer}</td><td>${badgeCh(classify(c.customer))}</td><td class="n">${F.$f(c.revenue)}</td><td class="n">${F.p(c.revenue/total*100)}</td><td class="n">${F.n(c.orders)}</td><td class="n">${F.$f(c.revenue/c.orders)}</td></tr>`});
  h+='</tbody></table></div></div>';
  
  // Insights
  var totalRevAll=all.reduce(function(s,r){return s+r.revenue},0);
  var top5=(all.slice(0,5).reduce(function(s,r){return s+r.revenue},0));
  var top5pct=totalRevAll>0?(top5/totalRevAll*100):0;
  
  h+='<div class="card"><div class="card-t" style="margin-bottom:14px">Account Intelligence</div>';
  
  if(top5pct>50){
    h+='<div class="insight-box insight-amber"><strong>Top 5 account concentration: '+F.p(top5pct)+'.</strong> This level of concentration creates significant revenue risk. Losing any one of these accounts would impact annual revenue by '+F.$(top5/5)+' on average. Diversification into mid-tier accounts should be a strategic priority.</div>';
  }
  
  // AOV analysis
  var highAOV=all.filter(function(r){return r.orders>=3&&r.revenue/r.orders>500});
  var lowFreq=all.filter(function(r){return r.orders===1&&r.revenue>500});
  
  if(highAOV.length>0){
    h+='<div class="insight-box insight-green"><strong>'+highAOV.length+' high-value repeat accounts</strong> (3+ orders, $500+ AOV). These are your brand champions. Consider exclusive product launches, early access programs, or volume-tiered pricing to deepen these relationships.</div>';
  }
  
  if(lowFreq.length>0){
    h+='<div class="insight-box insight-blue"><strong>'+lowFreq.length+' one-time high-value orders.</strong> These accounts placed a single order over $500 but never reordered. This is your lowest-hanging fruit for growth. A targeted follow-up campaign could reactivate 20-30% of these accounts based on industry benchmarks.</div>';
  }
  
  // Strategic questions
  h+='<div class="q-box"><div class="q-box-title">Wholesale Growth Questions</div><ul>';
  h+='<li><strong>Account segmentation:</strong> Which accounts are growing vs declining vs dormant? What is our formal account tiering framework?</li>';
  h+='<li><strong>New business pipeline:</strong> How many new wholesale accounts have we onboarded in the last 90 days? What is the average time from first order to becoming a regular reorder account?</li>';
  h+='<li><strong>Payment terms:</strong> Are our payment terms competitive with what wholesale buyers expect? Are we losing deals on terms rather than product or price?</li>';
  h+='<li><strong>Minimum order thresholds:</strong> What is the minimum profitable order size after factoring in picking, packing, and shipping costs? Are any accounts consistently below this threshold?</li>';
  h+='</ul></div>';
  h+='</div>';
  
  return h;
};

// ==================== MARGIN ANALYSIS ====================
PG.margin=function(){
  var ms=D.margin_sku,mc=D.margin_channel,mm=D.margin_monthly,mt=D.margin_sku_trend,pc=D.part_costs,cl=D.cost_lookup;
  ms=Array.isArray(ms)?ms:[];mc=Array.isArray(mc)?mc:[];mm=Array.isArray(mm)?mm:[];mt=Array.isArray(mt)?mt:[];pc=Array.isArray(pc)?pc:[];cl=Array.isArray(cl)?cl:[];

  // Cost source analysis from cost_lookup
  var costSrc={std:0,po:0,none:0,stdRev:0,poRev:0,noneRev:0};
  cl.forEach(function(p){
    if(p.stdCost>0)costSrc.std++;
    else if(p.lastPoCost>0)costSrc.po++;
    else costSrc.none++;
  });

  // Cost is calculated at SQL level: qty * part.stdCost via JOIN
  var hasCostData=ms.some(function(s){return s.cost>0});

  // Totals
  var totalRev=0,totalCost=0,totalQty=0;
  ms.forEach(function(s){totalRev+=s.revenue;totalCost+=s.cost;totalQty+=s.qty});
  var grossProfit=totalRev-totalCost;
  var grossMargin=totalRev>0?(grossProfit/totalRev*100):0;

  // Channel aggregation
  var chMap={};
  mc.forEach(function(r){
    var ch=classify(r.customer);
    if(!chMap[ch])chMap[ch]={revenue:0,cost:0,qty:0,orders:0};
    chMap[ch].revenue+=r.revenue;chMap[ch].cost+=r.cost;chMap[ch].qty+=r.qty;chMap[ch].orders+=r.orders;
  });
  var chList=Object.entries(chMap).sort(function(a,b){return b[1].revenue-a[1].revenue});

  // Category aggregation from SKU data
  var catMap={};
  ms.forEach(function(s){
    var cat=categorize(s.productNum,s.description);
    if(cat==='Subtotal'||cat==='Shipping'||cat==='Adjustments')return;
    if(!catMap[cat])catMap[cat]={revenue:0,cost:0,qty:0,count:0};
    catMap[cat].revenue+=s.revenue;catMap[cat].cost+=s.cost;catMap[cat].qty+=s.qty;catMap[cat].count++;
  });
  var catList=Object.entries(catMap).filter(function(x){return x[1].revenue>0}).sort(function(a,b){return b[1].revenue-a[1].revenue});

  // Monthly trend
  var moData=mm.map(function(m){
    var gp=m.revenue-m.cost;
    return{yr:m.yr,mo:m.mo,label:F.mo(m.mo)+' '+m.yr,revenue:m.revenue,cost:m.cost,profit:gp,margin:m.revenue>0?(gp/m.revenue*100):0,qty:m.qty};
  }).sort(function(a,b){return(a.yr*100+a.mo)-(b.yr*100+b.mo)});

  // Cost data quality check
  var skusWithCost=ms.filter(function(s){return s.cost>0&&s.revenue>0}).length;
  var skusTotal=ms.filter(function(s){return s.revenue>0}).length;
  var costCoverage=skusTotal>0?Math.min(100,skusWithCost/skusTotal*100):0;

  // Industry benchmarks for specialty food
  var benchmarks={
    dtc_margin:65,wholesale_margin:42,grocery_margin:30,
    overall_margin:52,cogs_ratio:48,
    healthy_margin_floor:40
  };

  // Filter good SKUs
  var goodSkus=ms.filter(function(s){return s.revenue>100&&!['Subtotal','Shipping','Adjustments'].includes(categorize(s.productNum,s.description))});
  goodSkus.sort(function(a,b){return b.revenue-a.revenue});

  // Identify margin outliers
  var highMargin=goodSkus.filter(function(s){return s.revenue>0&&s.cost>0&&((s.revenue-s.cost)/s.revenue*100)>70}).sort(function(a,b){return(b.revenue-b.cost)-(a.revenue-a.cost)});
  var lowMargin=goodSkus.filter(function(s){return s.revenue>0&&s.cost>0&&((s.revenue-s.cost)/s.revenue*100)<30}).sort(function(a,b){return a.revenue-a.cost-(b.revenue-b.cost)});
  var marginDestroyers=goodSkus.filter(function(s){return s.cost>s.revenue}).sort(function(a,b){return(a.revenue-a.cost)-(b.revenue-b.cost)});

  // Top 20 by profit contribution
  var byProfit=goodSkus.filter(function(s){return s.cost>0}).map(function(s){return{pn:s.productNum,desc:s.description,revenue:s.revenue,cost:s.cost,profit:s.revenue-s.cost,margin:s.revenue>0?((s.revenue-s.cost)/s.revenue*100):0,qty:s.qty,cat:categorize(s.productNum,s.description)}}).sort(function(a,b){return b.profit-a.profit});

  var h='';

  // === HEADER ===
  h+='<div style="margin-bottom:28px"><div class="page-title">Sales Margin Analysis</div>';
  h+='<div class="page-sub">Fiscal YTD: Jul 27, 2025 - Present</div></div>';

  // Data quality notice
  if(costCoverage<50){
    h+='<div class="insight-box insight-amber"><strong>Data note:</strong> Cost data available for '+skusWithCost+' of '+skusTotal+' SKUs ('+F.p(costCoverage)+' coverage). '+(hasCostData?'Margins shown use actual SO cost where available, standard cost as fallback.':'Using standard cost from part master. Actual transactional costs not populated in Fishbowl SO items. Consider enabling cost tracking on sales orders for precise margin analysis.')+'</div>';
  }

  // === KPI ROW 1: Core Margin Metrics ===
  h+='<div class="kg" style="grid-template-columns:repeat(6,1fr)">';
  h+='<div class="kpi" style="border-left:3px solid var(--ac)"><div class="kpi-l">Gross Revenue</div><div class="kpi-v">'+F.$m(totalRev)+'</div></div>';
  h+='<div class="kpi" style="border-left:3px solid var(--rd)"><div class="kpi-l">Total COGS</div><div class="kpi-v">'+F.$m(totalCost)+'</div></div>';
  h+='<div class="kpi" style="border-left:3px solid var(--gn)"><div class="kpi-l">Gross Profit</div><div class="kpi-v" style="color:var(--gn)">'+F.$m(grossProfit)+'</div></div>';
  var gmColor=grossMargin>=benchmarks.healthy_margin_floor?'var(--gn)':'var(--rd)';
  h+='<div class="kpi" style="border-left:3px solid '+gmColor+'"><div class="kpi-l">Gross Margin %</div><div class="kpi-v" style="color:'+gmColor+'">'+F.p(grossMargin)+'</div><div class="kpi-sub">Target: '+benchmarks.overall_margin+'%</div></div>';
  var profitPerOrder=chList.reduce(function(s,x){return s+x[1].orders},0);
  h+='<div class="kpi"><div class="kpi-l">Profit/Order</div><div class="kpi-v">'+F.$(profitPerOrder>0?grossProfit/profitPerOrder:0)+'</div></div>';
  var profitPerUnit=totalQty>0?grossProfit/totalQty:0;
  h+='<div class="kpi"><div class="kpi-l">Profit/Unit</div><div class="kpi-v">'+F.$(profitPerUnit)+'</div></div>';
  h+='</div>';

  // Cost Data Sources
  var clTotal=cl.length||1;
  h+='<div class="card" style="margin-bottom:20px"><div class="card-t" style="margin-bottom:12px">Cost Data Sources</div>';
  h+='<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:12px">';
  h+='<div style="background:var(--gnl);border-radius:8px;padding:14px;border-left:4px solid var(--gn)"><div style="font-size:22px;font-weight:700;color:var(--gn)">'+costSrc.std+'</div><div style="font-size:12px;color:var(--txm)">Standard Cost (Tier 1)</div></div>';
  h+='<div style="background:#eff6ff;border-radius:8px;padding:14px;border-left:4px solid var(--ac)"><div style="font-size:22px;font-weight:700;color:var(--ac)">'+costSrc.po+'</div><div style="font-size:12px;color:var(--txm)">Resolved via PO/BOM/Kit (Tiers 2-7)</div></div>';
  h+='<div style="background:var(--rdl);border-radius:8px;padding:14px;border-left:4px solid var(--rd)"><div style="font-size:22px;font-weight:700;color:var(--rd)">'+costSrc.none+'</div><div style="font-size:12px;color:var(--txm)">Unresolved (displays, shipping, accessories)</div></div>';
  h+='</div>';
  if(costSrc.none>20)h+='<div class="insight-box insight-amber" style="margin-top:12px"><strong>'+costSrc.none+' parts have no cost source.</strong> Neither standard cost nor purchase order history exists for these items. They show as $0 COGS and compress reported margins. Enter costs in Fishbowl Part module or create POs.</div>';
  h+='</div>';

  // === MARGIN HEALTH SCORECARD ===
  h+='<div class="card"><div class="card-t" style="margin-bottom:16px">Margin Health Scorecard</div>';
  h+='<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:12px">';

  function healthCard(label,value,target,unit,inverse){
    var pct=unit==='%';
    var good=inverse?(value<target):(value>=target);
    var color=good?'var(--gn)':'var(--rd)';
    var icon=good?'\u2705':'\u26a0\ufe0f';
    return '<div style="background:var(--sf2);border-radius:10px;padding:16px;border-left:4px solid '+color+'"><div style="display:flex;justify-content:space-between;align-items:center"><div style="font-size:12px;color:var(--txm);font-weight:500">'+label+'</div><div>'+icon+'</div></div><div style="font-size:22px;font-weight:700;margin-top:6px;color:'+color+'">'+(pct?F.p(value):F.$(value))+'</div><div style="font-size:11px;color:var(--txm);margin-top:2px">Target: '+(pct?F.p(target):F.$(target))+'</div></div>';
  }

  h+=healthCard('Overall Gross Margin',grossMargin,benchmarks.overall_margin,'%',false);

  // DTC margin (Ecom + POS)
  var dtcRev=0,dtcCost=0;
  chList.forEach(function(x){if(x[0]==='Ecommerce'||x[0]==='POS'){dtcRev+=x[1].revenue;dtcCost+=x[1].cost}});
  var dtcMargin=dtcRev>0?((dtcRev-dtcCost)/dtcRev*100):0;
  h+=healthCard('DTC Margin',dtcMargin,benchmarks.dtc_margin,'%',false);

  // Wholesale margin
  var whoRev=0,whoCost=0;
  chList.forEach(function(x){if(x[0].includes('Wholesale')){whoRev+=x[1].revenue;whoCost+=x[1].cost}});
  var whoMargin=whoRev>0?((whoRev-whoCost)/whoRev*100):0;
  h+=healthCard('Wholesale Margin',whoMargin,benchmarks.wholesale_margin,'%',false);

  // Grocery margin
  var grcRev=(chMap['Grocery']||{revenue:0}).revenue,grcCost=(chMap['Grocery']||{cost:0}).cost;
  var grcMargin=grcRev>0?((grcRev-grcCost)/grcRev*100):0;
  h+=healthCard('Grocery Margin',grcMargin,benchmarks.grocery_margin,'%',false);

  // COGS ratio
  var cogsRatio=totalRev>0?(totalCost/totalRev*100):0;
  h+=healthCard('COGS Ratio',cogsRatio,benchmarks.cogs_ratio,'%',true);

  // Cost coverage
  h+=healthCard('Cost Data Coverage',costCoverage,80,'%',false);
  h+='</div></div>';

  // === KEY INSIGHTS ===
  h+='<div class="card"><div class="card-t" style="margin-bottom:14px">Margin Intelligence</div>';

  // Auto-generate insights based on data
  if(grossMargin>=benchmarks.overall_margin){
    h+='<div class="insight-box insight-green"><strong>Margin on target.</strong> At '+F.p(grossMargin)+', overall gross margin meets the '+benchmarks.overall_margin+'% specialty food benchmark. Focus on maintaining pricing discipline while scaling volume.</div>';
  }else{
    h+='<div class="insight-box insight-red"><strong>Margin below target.</strong> At '+F.p(grossMargin)+' vs '+benchmarks.overall_margin+'% benchmark. Gap represents '+F.$(totalRev*(benchmarks.overall_margin/100)-(totalRev-totalCost))+' in unrealized profit at current revenue.</div>';
  }

  if(marginDestroyers.length>0){
    var destroyerLoss=marginDestroyers.reduce(function(s,x){return s+(x.cost-x.revenue)},0);
    h+='<div class="insight-box insight-red"><strong>'+marginDestroyers.length+' SKUs are margin negative.</strong> These products cost more to produce than they sell for, destroying '+F.$(destroyerLoss)+' in profit. Review pricing or consider discontinuation.</div>';
  }

  // Concentration: top 10 SKUs profit contribution
  var top10profit=byProfit.slice(0,10).reduce(function(s,x){return s+x.profit},0);
  var totalProfitFromCost=byProfit.reduce(function(s,x){return s+x.profit},0);
  if(totalProfitFromCost>0){
    h+='<div class="insight-box insight-blue"><strong>Profit concentration:</strong> Top 10 SKUs generate '+F.p(top10profit/totalProfitFromCost*100)+' of gross profit ('+F.$(top10profit)+'). Monitor these closely for cost increases or demand shifts.</div>';
  }

  // Channel mix impact
  if(whoRev>dtcRev&&whoMargin<dtcMargin){
    h+='<div class="insight-box insight-amber"><strong>Channel mix is compressing margin.</strong> Wholesale ('+F.p(whoMargin)+' margin) is now larger than DTC ('+F.p(dtcMargin)+' margin). Every 1% shift from DTC to wholesale reduces blended margin by ~'+F.p((dtcMargin-whoMargin)*0.01)+'. Grow DTC to protect overall margin.</div>';
  }
  // Weighted average selling price
  var totalAvgPrice=totalQty>0?totalRev/totalQty:0;
  var totalAvgCost=totalQty>0?totalCost/totalQty:0;
  if(totalAvgPrice>0&&totalAvgCost>0){
    h+='<div class="insight-box insight-purple"><strong>Unit economics:</strong> Average selling price is '+F.$(totalAvgPrice)+' with average unit cost of '+F.$(totalAvgCost)+', yielding '+F.$(totalAvgPrice-totalAvgCost)+' gross profit per unit. Each 5% price increase would add approximately '+F.$(totalRev*0.05)+' to gross profit with zero incremental cost.</div>';
  }

  // Coverage insight
  if(costCoverage>=90){
    h+='<div class="insight-box insight-green"><strong>Cost data quality is strong.</strong> '+F.p(costCoverage)+' of sold SKUs have resolved costs via our 7-tier waterfall (standard cost, PO+UOM, BOM rollup, kit components, case pack derivation). The '+F.n(skusTotal-skusWithCost)+' uncosted items are primarily display materials, shipping, and accessories that do not carry product cost.</div>';
  }
  h+='</div>';

  // === MARGIN BY CHANNEL === 
  h+='<div class="cr">';
  // Channel donut by PROFIT (not revenue)
  var chProfitData=chList.map(function(x,i){return{label:x[0],value:Math.max(0,x[1].revenue-x[1].cost),color:COLORS[i%COLORS.length]}});
  h+='<div class="card"><div class="card-t" style="margin-bottom:10px">Gross Profit by Channel</div>';
  h+='<div class="donut-wrap">'+donut(chProfitData,160)+'<div class="donut-legend">'+donutLegend(chProfitData)+'</div></div></div>';

  // Channel margin table
  h+='<div class="card"><div class="card-hd"><div class="card-t">Channel Margin Detail</div><button class="xb" onclick="xT(\'mch\')">Export</button></div>';
  h+='<table class="dt" id="mch"><thead><tr><th>Channel</th><th class="n">Revenue</th><th class="n">COGS</th><th class="n">Gross Profit</th><th class="n">Margin %</th><th class="n">Orders</th><th class="n">Profit/Order</th></tr></thead><tbody>';
  chList.forEach(function(x){
    var ch=x[0],d=x[1],gp=d.revenue-d.cost,gm=d.revenue>0?(gp/d.revenue*100):0;
    var mColor=gm>=benchmarks.healthy_margin_floor?'var(--gn)':'var(--rd)';
    h+='<tr><td style="font-weight:500">'+ch+'</td><td class="n">'+F.$f(d.revenue)+'</td><td class="n">'+F.$f(d.cost)+'</td><td class="n" style="color:var(--gn)">'+F.$f(gp)+'</td><td class="n" style="color:'+mColor+';font-weight:600">'+F.p(gm)+'</td><td class="n">'+F.n(d.orders)+'</td><td class="n">'+F.$(d.orders>0?gp/d.orders:0)+'</td></tr>';
  });
  var totOrd=chList.reduce(function(s,x){return s+x[1].orders},0);
  h+='<tr style="font-weight:700;border-top:2px solid var(--ac)"><td>TOTAL</td><td class="n">'+F.$f(totalRev)+'</td><td class="n">'+F.$f(totalCost)+'</td><td class="n" style="color:var(--gn)">'+F.$f(grossProfit)+'</td><td class="n" style="font-weight:700">'+F.p(grossMargin)+'</td><td class="n">'+F.n(totOrd)+'</td><td class="n">'+F.$(totOrd>0?grossProfit/totOrd:0)+'</td></tr>';
  h+='</tbody></table></div>';
  h+='</div>';

  // === MARGIN BY CATEGORY ===
  h+='<div class="card"><div class="card-hd"><div class="card-t">Category Margin Analysis</div><button class="xb" onclick="xT(\'mcat\')">Export</button></div>';
  h+='<table class="dt" id="mcat"><thead><tr><th>Category</th><th class="n">Revenue</th><th class="n">COGS</th><th class="n">Gross Profit</th><th class="n">Margin %</th><th class="n">SKUs</th><th class="n">Rev/SKU</th><th class="n">Profit/SKU</th></tr></thead><tbody>';
  catList.forEach(function(x){
    var cat=x[0],d=x[1],gp=d.revenue-d.cost,gm=d.revenue>0?(gp/d.revenue*100):0;
    var mColor=gm>=benchmarks.healthy_margin_floor?'var(--gn)':'var(--rd)';
    h+='<tr><td style="font-weight:500">'+cat+'</td><td class="n">'+F.$f(d.revenue)+'</td><td class="n">'+F.$f(d.cost)+'</td><td class="n" style="color:var(--gn)">'+F.$f(gp)+'</td><td class="n" style="color:'+mColor+';font-weight:600">'+F.p(gm)+'</td><td class="n">'+d.count+'</td><td class="n">'+F.$(d.count>0?d.revenue/d.count:0)+'</td><td class="n">'+F.$(d.count>0?gp/d.count:0)+'</td></tr>';
  });
  h+='</tbody></table></div>';

  // === MARGIN TREND (monthly) ===
  if(moData.length>0){
    // Visual bar chart using CSS
    var maxRev=Math.max.apply(null,moData.map(function(m){return m.revenue}));
    h+='<div class="card"><div class="card-hd"><div class="card-t">Monthly Margin Trend</div><button class="xb" onclick="xT(\'mtrend\')">Export</button></div>';
    
    // Mini visual bars
    h+='<div style="display:flex;gap:6px;align-items:end;height:120px;margin-bottom:16px;padding:0 4px">';
    moData.slice(-14).forEach(function(m){
      var h1=maxRev>0?(m.revenue/maxRev*100):0;
      var profitH=maxRev>0?(m.profit/maxRev*100):0;
      var barColor=m.margin>=benchmarks.healthy_margin_floor?'#059669':'#dc2626';
      h+='<div style="flex:1;display:flex;flex-direction:column;align-items:center;gap:2px">';
      h+='<div style="font-size:9px;color:var(--txm)">'+F.p(m.margin)+'</div>';
      h+='<div style="width:100%;display:flex;flex-direction:column;align-items:center">';
      h+='<div style="width:80%;height:'+h1+'px;background:'+barColor+';opacity:.2;border-radius:3px 3px 0 0;position:relative">';
      h+='<div style="position:absolute;bottom:0;width:100%;height:'+profitH+'px;background:'+barColor+';border-radius:3px 3px 0 0"></div>';
      h+='</div></div>';
      h+='<div style="font-size:9px;color:var(--txm);white-space:nowrap">'+F.mo(m.mo)+'</div>';
      h+='</div>';
    });
    h+='</div>';
    h+='<div style="font-size:11px;color:var(--txm);margin-bottom:12px">Full bar = revenue, filled = gross profit. Green = margin above '+benchmarks.healthy_margin_floor+'%, red = below.</div>';

    h+='<table class="dt" id="mtrend"><thead><tr><th>Month</th><th class="n">Revenue</th><th class="n">COGS</th><th class="n">Gross Profit</th><th class="n">Margin %</th><th class="n">Units</th><th class="n">Rev/Unit</th></tr></thead><tbody>';
    moData.slice().reverse().forEach(function(m){
      var mColor=m.margin>=benchmarks.healthy_margin_floor?'var(--gn)':'var(--rd)';
      h+='<tr><td>'+m.label+'</td><td class="n">'+F.$f(m.revenue)+'</td><td class="n">'+F.$f(m.cost)+'</td><td class="n" style="color:var(--gn)">'+F.$f(m.profit)+'</td><td class="n" style="color:'+mColor+';font-weight:600">'+F.p(m.margin)+'</td><td class="n">'+F.n(m.qty)+'</td><td class="n">'+(m.qty>0?F.$(m.revenue/m.qty):'-')+'</td></tr>';
    });
    h+='</tbody></table></div>';
  }

  // === TOP 25 PROFIT DRIVERS ===
  h+='<div class="card"><div class="card-hd"><div><div class="card-t">Top 25 Profit Drivers</div><div class="card-sub">Ranked by gross profit contribution</div></div><button class="xb" onclick="xT(\'msku\')">Export</button></div>';
  h+='<table class="dt" id="msku"><thead><tr><th>#</th><th>Product</th><th>Category</th><th class="n">Revenue</th><th class="n">COGS</th><th class="n">Gross Profit</th><th class="n">Margin %</th><th class="n">Qty</th></tr></thead><tbody>';
  byProfit.slice(0,25).forEach(function(s,i){
    var mColor=s.margin>=benchmarks.healthy_margin_floor?'var(--gn)':'var(--rd)';
    h+='<tr><td style="color:var(--txd)">'+(i+1)+'</td><td>'+(s.desc||'').substring(0,45)+'</td><td><span class="badge badge-who">'+s.cat+'</span></td><td class="n">'+F.$f(s.revenue)+'</td><td class="n">'+F.$f(s.cost)+'</td><td class="n" style="color:var(--gn)">'+F.$f(s.profit)+'</td><td class="n" style="color:'+mColor+';font-weight:600">'+F.p(s.margin)+'</td><td class="n">'+F.n(s.qty)+'</td></tr>';
  });
  h+='</tbody></table></div>';

  // === MARGIN DESTROYERS ===
  if(marginDestroyers.length>0||lowMargin.length>0){
    h+='<div class="card" style="border-color:var(--rd)"><div class="card-hd"><div><div class="card-t" style="color:var(--rd)">Margin Watch List</div><div class="card-sub">SKUs with margin below 30% or negative</div></div><button class="xb" onclick="xT(\'mwarn\')">Export</button></div>';
    h+='<table class="dt" id="mwarn"><thead><tr><th>#</th><th>Product</th><th>Category</th><th class="n">Revenue</th><th class="n">COGS</th><th class="n">Profit/Loss</th><th class="n">Margin %</th><th class="n">Qty</th></tr></thead><tbody>';
    var watchList=marginDestroyers.concat(lowMargin).map(function(s){return{pn:s.productNum,desc:s.description,revenue:s.revenue,cost:s.cost,profit:s.revenue-s.cost,margin:s.revenue>0?((s.revenue-s.cost)/s.revenue*100):0,qty:s.qty,cat:categorize(s.productNum,s.description)}});
    // Deduplicate
    var seen={};watchList=watchList.filter(function(s){if(seen[s.pn])return false;seen[s.pn]=true;return true});
    watchList.sort(function(a,b){return a.profit-b.profit});
    watchList.slice(0,20).forEach(function(s,i){
      var isNeg=s.profit<0;
      h+='<tr style="'+(isNeg?'background:var(--rdl)':'')+'"><td style="color:var(--txd)">'+(i+1)+'</td><td>'+(s.desc||'').substring(0,45)+'</td><td><span class="badge badge-who">'+s.cat+'</span></td><td class="n">'+F.$f(s.revenue)+'</td><td class="n">'+F.$f(s.cost)+'</td><td class="n" style="color:'+(isNeg?'var(--rd)':'var(--am)');
      h+='">'+F.$f(s.profit)+'</td><td class="n" style="color:var(--rd);font-weight:600">'+F.p(s.margin)+'</td><td class="n">'+F.n(s.qty)+'</td></tr>';
    });
    h+='</tbody></table></div>';
  }

  // === PRICING POWER ===
  h+='<div class="card"><div class="card-hd"><div><div class="card-t">Pricing Analysis by Category</div><div class="card-sub">Average selling price and margin relationship</div></div></div>';
  h+='<table class="dt"><thead><tr><th>Category</th><th class="n">Avg Sell Price</th><th class="n">Avg Unit Cost</th><th class="n">Profit/Unit</th><th class="n">Margin %</th><th class="n">Units Sold</th><th class="n">Total Profit</th></tr></thead><tbody>';
  catList.forEach(function(x){
    var cat=x[0],d=x[1];
    var avgPrice=d.qty>0?d.revenue/d.qty:0;
    var avgCost=d.qty>0?d.cost/d.qty:0;
    var profitUnit=avgPrice-avgCost;
    var gm=d.revenue>0?((d.revenue-d.cost)/d.revenue*100):0;
    var mColor=gm>=benchmarks.healthy_margin_floor?'var(--gn)':'var(--rd)';
    h+='<tr><td style="font-weight:500">'+cat+'</td><td class="n">'+F.$(avgPrice)+'</td><td class="n">'+F.$(avgCost)+'</td><td class="n" style="color:var(--gn)">'+F.$(profitUnit)+'</td><td class="n" style="color:'+mColor+';font-weight:600">'+F.p(gm)+'</td><td class="n">'+F.n(d.qty)+'</td><td class="n" style="color:var(--gn)">'+F.$f(d.revenue-d.cost)+'</td></tr>';
  });
  h+='</tbody></table></div>';

  // === STRATEGIC QUESTIONS ===
  h+='<div class="q-box"><div class="q-box-title">Margin Strategy Questions</div><ul>';
  h+='<li><strong>Cost reduction:</strong> Which raw material costs have increased most in the last 6 months? Are there alternative suppliers or formulation changes that could improve margins without affecting quality?</li>';
  h+='<li><strong>Pricing power:</strong> When was the last price increase across each channel? What is the price elasticity on our top 10 SKUs? Can we implement a 3-5% increase on wholesale without losing volume?</li>';
  h+='<li><strong>Channel strategy:</strong> Is the wholesale growth at the expense of overall margin? What is the minimum acceptable margin for new wholesale accounts?</li>';
  h+='<li><strong>SKU rationalization:</strong> What is the total cost (inventory carrying, warehouse, operational) of maintaining low-margin and negative-margin SKUs? Would discontinuing the bottom 20% improve overall margin by 2-3 points?</li>';
  h+='<li><strong>Mix optimization:</strong> Can we bundle high-margin products with lower-margin ones to improve blended margin while maintaining average order value?</li>';
  h+='<li><strong>Promotional impact:</strong> What is the margin impact of our promotional calendar? Are we measuring post-promotion baseline lift vs margin erosion?</li>';
  h+='</ul></div>';

  // Footer
  h+='<div class="note">COGS uses a 7-tier cost waterfall: (1) Standard cost, (2) Last PO with UOM conversion, (3) BOM rollup with UOM conversion, (4) Part-to-product mapping, (5) Case pack derivation, (6) Kit component rollup, (7) Prior inventory match. '+skusWithCost+' of '+skusTotal+' sold SKUs have resolved cost data. Industry benchmarks reference Specialty Food Association data for brands at $5M-$25M revenue.</div>';

  return h;
};



// ==================== ROADMAP ====================
PG.roadmap=function(){
  var h='<div style="margin-bottom:28px"><div class="page-title">Analytics Roadmap</div>';
  h+='<div class="page-sub">Planned capabilities for Kanel Sales Intelligence</div></div>';
  
  // Phase 1 - Current
  h+='<div class="card" style="border-left:4px solid var(--gn)"><div class="card-t" style="color:var(--gn);margin-bottom:14px">Phase 1: Foundation (Complete)</div>';
  h+='<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:12px">';
  h+='<div style="background:var(--gnl);padding:12px;border-radius:8px"><div style="font-weight:600;font-size:13px">Revenue Dashboard</div><div style="font-size:12px;color:var(--txm);margin-top:4px">Live Fishbowl data, YTD/MTD/WTD tracking, channel/category/SKU breakdowns</div></div>';
  h+='<div style="background:var(--gnl);padding:12px;border-radius:8px"><div style="font-weight:600;font-size:13px">Comp % Analysis</div><div style="font-size:12px;color:var(--txm);margin-top:4px">Year-over-year at channel, customer, and monthly level with gainers/decliners</div></div>';
  h+='<div style="background:var(--gnl);padding:12px;border-radius:8px"><div style="font-weight:600;font-size:13px">7-Tier Cost Resolution</div><div style="font-size:12px;color:var(--txm);margin-top:4px">Resolved costs for 548 products using stdCost, PO, BOM, kit rollup, case pack derivation</div></div>';
  h+='</div></div>';

  // Phase 2 - In Progress
  h+='<div class="card" style="border-left:4px solid var(--ac)"><div class="card-t" style="color:var(--ac);margin-bottom:14px">Phase 2: Deeper Intelligence (In Progress)</div>';
  h+='<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:12px">';
  h+='<div style="background:var(--acl);padding:12px;border-radius:8px"><div style="font-weight:600;font-size:13px">Customer Lifetime Value</div><div style="font-size:12px;color:var(--txm);margin-top:4px">CLV by channel, cohort analysis, churn risk scoring, reactivation opportunities</div></div>';
  h+='<div style="background:var(--acl);padding:12px;border-radius:8px"><div style="font-weight:600;font-size:13px">Forecast vs Actuals</div><div style="font-size:12px;color:var(--txm);margin-top:4px">Budget-to-actual comparison, forecast accuracy tracking, variance analysis by channel</div></div>';
  h+='<div style="background:var(--acl);padding:12px;border-radius:8px"><div style="font-weight:600;font-size:13px">Inventory Intelligence</div><div style="font-size:12px;color:var(--txm);margin-top:4px">Sell-through rates, days of supply, reorder alerts, dead stock identification</div></div>';
  h+='</div></div>';

  // Phase 3 - Planned
  h+='<div class="card" style="border-left:4px solid var(--purple)"><div class="card-t" style="color:var(--purple);margin-bottom:14px">Phase 3: Strategic Analytics (Planned)</div>';
  h+='<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:12px">';
  h+='<div style="background:var(--purplel);padding:12px;border-radius:8px"><div style="font-weight:600;font-size:13px">Price Elasticity Modeling</div><div style="font-size:12px;color:var(--txm);margin-top:4px">Measure volume impact of price changes per SKU and channel. Optimize pricing for margin.</div></div>';
  h+='<div style="background:var(--purplel);padding:12px;border-radius:8px"><div style="font-weight:600;font-size:13px">Promotional ROI Tracker</div><div style="font-size:12px;color:var(--txm);margin-top:4px">Baseline vs lift analysis for promos, margin impact measurement, calendar optimization</div></div>';
  h+='<div style="background:var(--purplel);padding:12px;border-radius:8px"><div style="font-weight:600;font-size:13px">Geographic Heatmaps</div><div style="font-size:12px;color:var(--txm);margin-top:4px">Province/state level revenue mapping, distribution gap analysis, market penetration scoring</div></div>';
  h+='</div></div>';

  // Phase 4 - Future
  h+='<div class="card" style="border-left:4px solid var(--am)"><div class="card-t" style="color:var(--am);margin-bottom:14px">Phase 4: Automation (Future)</div>';
  h+='<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:12px">';
  h+='<div style="background:var(--aml);padding:12px;border-radius:8px"><div style="font-weight:600;font-size:13px">Automated Weekly Report</div><div style="font-size:12px;color:var(--txm);margin-top:4px">Auto-generated PDF/email with key metrics, alerts, and commentary every Monday</div></div>';
  h+='<div style="background:var(--aml);padding:12px;border-radius:8px"><div style="font-weight:600;font-size:13px">Anomaly Detection</div><div style="font-size:12px;color:var(--txm);margin-top:4px">AI-powered alerts for unusual patterns in orders, returns, channel shifts, margin compression</div></div>';
  h+='<div style="background:var(--aml);padding:12px;border-radius:8px"><div style="font-weight:600;font-size:13px">Fishbowl Cost Sync</div><div style="font-size:12px;color:var(--txm);margin-top:4px">Push resolved costs back to Fishbowl stdCost after validation. Eliminate manual cost entry.</div></div>';
  h+='</div></div>';

  // Technical Architecture
  h+='<div class="card"><div class="card-t" style="margin-bottom:14px">Technical Architecture</div>';
  h+='<table class="dt"><thead><tr><th>Component</th><th>Technology</th><th>Status</th></tr></thead><tbody>';
  h+='<tr><td style="font-weight:500">Data Source</td><td>Fishbowl Inventory API (kanel.myfishbowl.com)</td><td><span class="pos">Live</span></td></tr>';
  h+='<tr><td style="font-weight:500">Proxy Server</td><td>Node.js middleware with session management</td><td><span class="pos">Running</span></td></tr>';
  h+='<tr><td style="font-weight:500">Cost Resolution</td><td>7-tier waterfall engine (548 products resolved)</td><td><span class="pos">Complete</span></td></tr>';
  h+='<tr><td style="font-weight:500">Dashboard</td><td>Single-file HTML/JS with real-time refresh</td><td><span class="pos">Live</span></td></tr>';
  h+='<tr><td style="font-weight:500">Inventory Analytics</td><td>Fishbowl part/BOM/kit queries</td><td><span style="color:var(--am)">Phase 2</span></td></tr>';
  h+='<tr><td style="font-weight:500">Forecast Module</td><td>Budget file integration + variance engine</td><td><span style="color:var(--purple)">Phase 3</span></td></tr>';
  h+='</tbody></table></div>';

  h+='<div class="note">This dashboard pulls live data from Fishbowl via API. No manual data entry required. Refresh to get the latest Fishbowl data in real-time.</div>';
  return h;
};

// NAV
document.querySelectorAll('.nav-item[data-page]').forEach(e=>{e.addEventListener('click',()=>{currentPage=e.dataset.page;document.querySelectorAll('.nav-item').forEach(n=>n.classList.toggle('active',n.dataset.page===currentPage));if(D)renderCurrent()})});

function exportOffline(){
  if(!D){alert('No data loaded yet. Refresh first.');return}
  try{
    // Get the full HTML source
    var src=document.documentElement.outerHTML;
    
    // Build a frozen data script that replaces the live fetch
    var frozenData=JSON.stringify(D);
    var today=new Date().toLocaleDateString('en-CA',{year:'numeric',month:'short',day:'numeric'});
    
    // Build the offline HTML from our current source
    // We inject the data and disable the proxy connection
    var offlineScript='<'+'script>\n'
      +'// OFFLINE SNAPSHOT - Generated '+today+'\n'
      +'// This file contains all data baked in. No proxy needed.\n'
      +'var OFFLINE_MODE=true;\n'
      +'var OFFLINE_DATA='+frozenData+';\n'
      +'</'+'script>\n';
    
    // Get our full page source
    var fullHtml=new XMLSerializer().serializeToString(document);
    
    // Actually, easier approach: rebuild from our own source
    // Clone the current document
    var clone=document.documentElement.cloneNode(true);
    
    // Remove setup screen
    var setup=clone.querySelector('#setupScreen');
    if(setup)setup.remove();
    
    // Make app visible
    var app=clone.querySelector('#app');
    if(app)app.classList.remove('hidden');
    
    // Update the title
    var title=clone.querySelector('title');
    if(title)title.textContent='Kanel Sales Hub - Offline ('+today+')';
    
    // Find the script tag and modify it
    var scripts=clone.querySelectorAll('script');
    var mainScript=null;
    for(var i=0;i<scripts.length;i++){
      if(scripts[i].textContent.indexOf('PG.exec')>-1){mainScript=scripts[i];break}
    }
    
    if(mainScript){
      // Prepend offline data injection and override refreshData/saveConfig
      var originalCode=mainScript.textContent;
      
      // Replace the config/fetch logic with offline data loading
      var offlineCode='\n// === OFFLINE MODE ===\n'
        +'var OFFLINE_DATA='+frozenData+';\n'
        +'var CFG={url:"offline"};\n'
        +'var D=OFFLINE_DATA;\n'
        +'function refreshData(){renderCurrent()}\n'
        +'function saveConfig(){}\n';
      
      // Remove the original CFG/fetch/refreshData/saveConfig blocks
      // We keep everything from "const F={" onward (formatters + page functions)
      var keepFrom=originalCode.indexOf('// Formatters');
      if(keepFrom<0) keepFrom=originalCode.indexOf('const F={');
      
      var keptCode=originalCode.substring(keepFrom);
      
      // Also need the nav click handler and renderCurrent
      mainScript.textContent=offlineCode+'\n'+keptCode;
    }
    
    // Hide refresh and export buttons in offline mode
    var refreshBtn=clone.querySelector('#refreshBtn');
    if(refreshBtn)refreshBtn.style.display='none';
    var exportBtn=clone.querySelector('#exportBtn');
    if(exportBtn)exportBtn.style.display='none';
    
    // Update the "last updated" text
    var lastUpdated=clone.querySelector('#lastUpdated');
    if(lastUpdated)lastUpdated.textContent='Offline snapshot - '+today;
    
    // Build final HTML
    var finalHtml='<!DOCTYPE html>\n<html lang="en">'+clone.innerHTML+'</html>';
    
    // Trigger download
    var blob=new Blob([finalHtml],{type:'text/html'});
    var url=URL.createObjectURL(blob);
    var a=document.createElement('a');
    a.href=url;
    a.download='Kanel_Sales_Hub_'+new Date().toISOString().split('T')[0]+'.html';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  }catch(e){
    alert('Export failed: '+e.message);
    console.error(e);
  }
}
</script>
</body></html>
